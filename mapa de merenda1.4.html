<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEMONSTRATIVO MENSAL MESTRE PACIFICO - DINÂMICO V5</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* CONFIGURAÇÃO PARA ORIENTAÇÃO PAISAGEM (IMPRESSÃO) */
        @page {
            size: A4 landscape;
            margin: 10mm;
        }

        /* Estilos Globais e do Corpo do Documento */
        body {
            font-family: 'Times New Roman', serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0; 
            font-size: 10pt;
            color: #000;
        }

        /* ---------------------------------------------------- */
        /* SIDEBAR (PAINEL DE EDIÇÃO) - FIXA */
        /* ---------------------------------------------------- */
        .sidebar {
            background-color: #f7f7f7;
            border-right: 1px solid #ddd;
            padding: 15mm 15px; 
            font-size: 9pt;
            overflow-y: auto;
            position: fixed; 
            top: 0; 
            left: 0; 
            bottom: 0; 
            width: 320px; 
            z-index: 1000; 
            box-sizing: border-box;
        }

        .sidebar h4 {
            color: #004a99;
            border-bottom: 2px solid #004a99;
            padding-bottom: 5px;
            margin-top: 20px;
            font-size: 11pt;
        }
        .sidebar h5 {
            margin-top: 15px;
            margin-bottom: 5px;
            font-size: 10pt;
        }

        .sidebar label {
            display: block;
            font-weight: bold;
            margin-top: 10px;
            margin-bottom: 3px;
            font-size: 9pt;
        }

        .sidebar input[type="text"],
        .sidebar input[type="number"],
        .sidebar input[type="date"],
        .sidebar select {
            width: 95%;
            padding: 3px;
            border: 1px solid #aaa;
            border-radius: 3px;
            box-sizing: border-box;
            font-size: 8pt;
            margin-bottom: 5px;
        }
        .sidebar .date-pair {
            display: flex;
            justify-content: space-between;
        }
        .sidebar .date-pair input {
            width: 48%;
        }

        .sidebar button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 9pt;
            margin-top: 10px;
            cursor: pointer;
            border-radius: 4px;
        }
        .sidebar button:hover {
            background-color: #45a049;
        }
        /* Botões de adicionar linha mantidos na sidebar */
        .sidebar .add-row-btn {
             background-color: #004a99;
             margin-bottom: 5px;
        }
        .sidebar .add-row-btn:hover {
             background-color: #003066;
        }
        

        /* ---------------------------------------------------- */
        /* CONTEÚDO PRINCIPAL - AGORA FLUTUANTE */
        /* ---------------------------------------------------- */
        .main-content-area {
            margin-left: 320px; 
            padding: 0 30px; 
            min-height: 100vh;
        }

        .document-container {
            width: 297mm;
            min-height: 210mm;
            margin: 30px auto; 
            padding: 0mm 15mm;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            box-sizing: border-box;
        }

        /* Impede que a sidebar apareça na impressão */
        @media print {
            .sidebar {
                display: none;
            }
            .main-content-area {
                margin-left: 0;
            }
            .document-container {
                margin: 0;
                box-shadow: none;
            }
        }
        
        /* ---------------------------------------------------- */
        /* ESTILOS DE TABELA DINÂMICA */
        /* ---------------------------------------------------- */
        .data-table table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            margin-bottom: 15px;
        }
        .data-table th, .data-table td {
            border: 1px solid #000;
            padding: 2px;
            text-align: center;
            font-size: 7.5pt;
            word-break: break-word; 
            white-space: normal !important;
            vertical-align: middle;
        }
        .data-table th {
            font-weight: bold;
            background-color: #e0e0e0;
        }
        
        /* Adicionar estilos para o Timbre (Cabeçalho Institucional) */
        .header-institutional {
            text-align: center;
            margin-bottom: 20px; /* Espaço entre o timbre e o título */
            padding-top: 10px;
        }

        #timbre-imagem {
            max-width: 100%;
            display: block; /* Garante o alinhamento central */
        }
        /* Estilos para INPUTs e SELECTs dentro das CÉLULAS */
        .data-table input[type="text"],
        .data-table input[type="number"],
        .data-table input[type="date"],
        .data-table select {
            width: 90%;
            padding: 0;
            margin: 0;
            border: none;
            text-align: center;
            font-size: 7.5pt;
            background: transparent;
        }

        /* Tabela 2 - Estilo de Texto/Lista para Cardápio e Observações */
        #table-cardapio-body td:nth-child(6) select {
            width: 98%;
            text-align: left;
        }
        #table-cardapio-body td:nth-child(8) input {
             width: 98%;
             text-align: left;
        }
        
        /* NOVO: Estilo para centralizar número e unidade na mesma linha (Tabela 3) */
        #tabela-estoque .quantity-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        #tabela-estoque .quantity-cell input {
            width: 70%; 
            text-align: right;
            padding-right: 2px;
        }
        #tabela-estoque .quantity-cell .unit {
            width: 30%;
            text-align: left;
            padding-left: 2px;
        }
        /* Ajuste específico para a descrição do gênero */
        #tabela-estoque td:nth-child(2) select {
            width: 98%;
            text-align: left;
        }


        /* Estilo para o botão de remoção */
        .remove-row-btn {
            background: none;
            border: none;
            color: red;
            cursor: pointer;
            font-size: 10pt;
            padding: 0 2px;
            line-height: 1;
        }
        .remove-row-btn:hover {
            color: darkred;
        }

        /* ---------------------------------------------------- */
        /* ESTILOS DO DOCUMENTO (MANTIDOS/AJUSTADOS) */
        /* ---------------------------------------------------- */
        
        #tabela-detalhes td {
            height: 30px; 
            vertical-align: middle;
        }
        #tabela-estoque th, #tabela-estoque td {
            text-align: left;
        }
        #tabela-estoque td:nth-child(1), #tabela-estoque td:nth-child(3), #tabela-estoque td:nth-child(4), #tabela-estoque td:nth-child(5) {
            text-align: center;
        }
        .footer-document {
            margin-top: 50px;
            padding-top: 10px;
        }
        .signatures {
            display: flex;
            justify-content: space-around;
            text-align: center;
            margin-bottom: 20px;
        }
        .signatures div {
            width: 30%;
        }
        .signatures hr {
            border: 0;
            border-top: 1px solid #000;
            margin-bottom: 5px;
        }
        #tabela-detalhes span {
            display: block;
            width: 100%;
        }

        /* Adicionar estilos para o Rodapé Institucional */
        .footer-semed {
            text-align: center;
            margin-top: 15px; /* Espaçamento entre as assinaturas e o rodapé */
        }

        #rodape-imagem {
            width: 100%; /* Garante que o rodapé ocupe a largura total do container */
            display: block;
        }
        
        /* 1. Permite que as linhas da tabela cresçam conforme o conteúdo */
        #table-cardapio-body tr,
        #table-estoque-body tr {
            height: auto !important;
        }

        /* 2. Estilo para as células clicáveis */
        #table-cardapio-body td:nth-child(3), /* NOVA: Freq Creche */
        #table-cardapio-body td:nth-child(4), /* NOVA: Freq Ed Inf/Fund */
        #table-cardapio-body td:nth-child(5), /* NOVA: Freq EJA */
        #table-cardapio-body td:nth-child(6), /* Cardápio */
        #table-cardapio-body td:nth-child(8), /* Justificativa */
        #table-estoque-body td:nth-child(6) { /* Relatório */
            vertical-align: top;
            padding: 0; 
            cursor: pointer; 
            text-align: center; /* CENTRALIZAÇÃO: Centraliza as colunas de frequência */
        }

        /* 3. Estilo para a tag <p> (Modo de visualização) */
        #table-cardapio-body td p,
        #table-estoque-body td p {
            margin: 0;
            min-height: 10px; /* Altura mínima para não colapsar a linha */
            padding: 4px 5px;
            border: 1px solid transparent; 
            transition: background-color 0.2s;
            text-align: left;
            white-space: pre-wrap; /* Permite quebras de linha e texto envolvente */
        }

        /* Efeito visual ao passar o mouse */
        #table-cardapio-body td:hover p,
        #table-estoque-body td:hover p {
            background-color: #f0f0f0;
        }

        /* 4. Estilos para os campos dinâmicos (Modo de edição) */
        #table-cardapio-body select.edit-field,
        #table-cardapio-body textarea.edit-field,
        #table-estoque-body textarea.edit-field {
            width: 100%;
            height: auto; /* Altura controlada pelo JS */
            box-sizing: border-box;
            padding: 2px;
            margin: 0;
            border: 1px solid #000;
            resize: vertical; /* Permite que o usuário redimensione a altura */
            min-height: 40px; 
            overflow-y: hidden;
            line-height: 1.2;
        }

        /* Garante que o select ocupe a altura mínima para ser visível */
        #table-cardapio-body select.edit-field {
            min-height: 30px;
        }
        
        /* 5. Centralização para conteúdo vazio (NOVA REGRA) */
        #table-cardapio-body td .center-if-empty,
        #table-estoque-body td .center-if-empty {
            text-align: center !important;
        }
        /* 3.1 Estilo específico para as tags <p> de Frequência (NOVO) */
        #table-cardapio-body td:nth-child(3) p, 
        #table-cardapio-body td:nth-child(4) p, 
        #table-cardapio-body td:nth-child(5) p {
            text-align: center; 
            white-space: nowrap; /* Não quebra linha em números curtos/X */
        }

        /* 4.1 Estilo específico para o input de Frequência (NOVO) */
        #table-cardapio-body input.attendance-edit-field {
            width: 100%;
            height: 30px; 
            box-sizing: border-box;
            padding: 2px;
            margin: 0;
            border: 1px solid #000;
            text-align: center;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h4>1. Detalhes da Escola (Tabela 1)</h4>

        <label for="nome_escola_input">NOME DA ESCOLA</label>
        <select id="nome_escola_input">
            <option value="Escola Mestre Pacífico" selected>Escola Mestre Pacífico</option>
            <option value="Escola João Fernandes de Oliveira">Escola João Fernandes de Oliveira</option>
            <option value="Escola Marilda Carvalho">Escola Marilda Carvalho</option>
            <option value="Escola Raimundo Pereira">Escola Raimundo Pereira</option>
            <option value="Escola Mestre Pacífico - CEMEP">Escola Mestre Pacífico - CEMEP</option>
            <option value="Escola Mestre Pacífico - INTEGRAL">Escola Mestre Pacífico - INTEGRAL</option>
        </select>

        <label for="endereco_escola_input">ENDEREÇO</label>
        <select id="endereco_escola_input">
            <option value="Comunidade Igarapé Açu" selected>Comunidade Igarapé Açu</option>
            <option value="Comunidade Ipixuna">Comunidade Ipixuna</option>
            <option value="Comunidade Arumã">Comunidade Arumã</option>
        </select>
        
        <label for="meio_escola_input">MEIO</label>
        <select id="meio_escola_input">
            <option value="Terra Firme" selected>Terra Firme</option>
        </select>

        <label for="municipio_escola_input">MUNICÍPIO</label>
        <select id="municipio_escola_input">
            <option value="Óbidos" selected>Óbidos</option>
        </select>

        <label for="num_alunos_input">N° DE ALUNOS MATRICULADOS</label>
        <input type="number" id="num_alunos_input" value="330">
        
        <label for="tipo_ensino_input">TIPO DE ENSINO</label>
        <select id="tipo_ensino_input">
            <option value="Ed. Inf. E Ens. Fund." selected>Ed. Inf. E Ens. Fund.</option>
            <option value="Ed. Infantil">Ed. Infantil</option>
            <option value="Ens. Fundamental">Ens. Fundamental</option>
        </select>
        <h5>Seleção de Cardápio</h5>
        <div style="margin-bottom: 10px; display: flex; justify-content: space-around;">
            <div>
                <input type="radio" id="cardapio_regular" name="tipo_cardapio" value="regular" checked>
                <label for="cardapio_regular" style="display: inline; width: auto; margin-left: 5px;">Regular</label>
            </div>
            <div>
                <input type="radio" id="cardapio_integral" name="tipo_cardapio" value="integral">
                <label for="cardapio_integral" style="display: inline; width: auto; margin-left: 5px;">Integral</label>
            </div>
        </div>
        
        <label for="periodo_input">PERÍODO (Início e Fim) - Gera as datas da Tabela 2</label>
        <div class="date-pair">
            <input type="date" id="periodo_inicio_input" value="2025-09-01" onchange="generateTable2Rows()">
            <input type="date" id="periodo_fim_input" value="2025-09-30" onchange="generateTable2Rows()">
        </div>
        <button onclick="generateTable2Rows()">Gerar Datas e Cardápios (Tabela 2)</button>

        
        <hr style="margin-top: 20px;">
        
        <h5>Data do Documento</h5>
        <input type="date" id="document_date_input" class="data-input">

        <hr style="margin-top: 20px;">

        <h5>Gerenciamento de Linhas</h5>
        <button class="add-row-btn" onclick="addRowTable2()">+ Adicionar Linha (Tabela 2)</button>
        <button class="add-row-btn" onclick="addRowTable3()">+ Adicionar Linha (Tabela 3)</button>

        <h5>Gerenciamento de Dados</h5>
        <button class="generate-btn" onclick="exportDataToTEXT()" style="background-color: #f7931e;">
            Exportar Dados (Planilha)
        </button>
        <input type="file" id="import_file" accept=".txt" style="margin-bottom: 5px;">
        <button class="generate-btn" onclick="document.getElementById('import_file').click()" style="background-color: #5cb85c; margin-top: 0;">
            Selecionar Arquivo
        </button>
        <button class="generate-btn" onclick="importDataFromTEXT()" style="background-color: #337ab7; margin-top: 5px;">
            Importar Dados
        </button>

        <p style="font-size: 8pt; margin-top: 20px;">*A Tabela 3 é preenchida automaticamente com os itens do cardápio.</p>
        <button onclick="window.print()" style="background-color: #d9534f; margin-top: 20px;">
            &#x1F5B6; Imprimir Documento (A4 Paisagem)
        </button>
        <div class="botoes-excel">
            <button onclick="exportarTabelasParaExcel()">📤 Exportar Tabelas</button>
            <input type="file" id="excelInput" accept=".xlsx, .xls" onchange="importarTabelasExcel(event)">
        </div>

    </div>
    <div class="main-content-area">
        <div class="document-container">

            <div class="header-institutional">
                <img id="timbre-imagem" src="timbre.png" alt="Logotipo da Instituição">
            </div>

            <h2 style="text-align: center; font-size: 11pt; margin: 10px 0; text-decoration: underline;">DEMONSTRATIVO MENSAL DA DISTRIBUIÇÃO DE REFEIÇÕES E CONSUMO DE GÊNEROS ALIMENTÍCIOS NA ESCOLA</h2>

            <div class="data-table">
                <table id="tabela-detalhes">
                    <thead>
                        <tr>
                            <th style="width: 15%;">NOME DA ESCOLA</th>
                            <th style="width: 18%;">ENDEREÇO</th>
                            <th style="width: 8%;">MEIO</th>
                            <th style="width: 10%;">MUNICÍPIO</th>
                            <th style="width: 13%;">DEPENDÊNCIA ADMINISTRATIVA</th>
                            <th style="width: 10%;">N° DE ALUNOS MATRICULADOS</th>
                            <th style="width: 13%;">TIPO DE ENSINO</th>
                            <th style="width: 13%;">PERÍODO</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span id="nome_escola_display">Escola Mestre Pacífico</span></td>
                            <td><span id="endereco_escola_display">Comunidade Igarapé Açu</span></td>
                            <td><span id="meio_escola_display">Terra Firme</span></td>
                            <td><span id="municipio_escola_display">Óbidos</span></td>
                            <td>Municipal</td>
                            <td><span id="num_alunos_display">330</span></td>
                            <td><span id="tipo_ensino_display">Ed. Inf. E Ens. Fund.</span></td>
                            <td><span id="periodo_display">01/09/2025<br>30/09/2025</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="data-table" id="table-cardapio">
                <table class="table-cardapio">
                    <thead>
                        <tr>
                            <th rowspan="2" style="width: 3%;">QUANT. DIAS</th>
                            <th rowspan="2" style="width: 9%;">FREQ. DO DIA/<br>DATA</th>
                            <th colspan="3">ALUNOS ATENDIDOS</th>
                            <th rowspan="2" style="width: 35%;">CARDÁPIO</th>
                            <th rowspan="2" style="width: 2%;"></th>
                            <th rowspan="2" style="width: 34%;">JUSTIFICATIVA / OBSERVAÇÃO</th>
                        </tr>
                        <tr>
                            <th style="width: 8%;">CRECHE</th>
                            <th style="width: 11%;">ED. INF. E FUNDAMENTAL</th>
                            <th style="width: 8%;">EJA</th>
                        </tr>
                    </thead>
                    <tbody id="table-cardapio-body">
                        </tbody>
                </table>
            </div>
            
            <div class="data-table" id="table-mapa">
                <h3 style="text-align: center; font-size: 10pt; font-weight: bold; margin-bottom: 5px;">CONTROLE DE GÊNEROS ALIMENTÍCIOS</h3>
                <table id="tabela-estoque">
                    <thead>
                        <tr>
                            <th colspan="2" style="width: 20%;">GÊNEROS RECEBIDOS DO PROGRAMA</th>
                            <th rowspan="2" style="width: 6%;">QUANT. DE ALIM. CONS.</th>
                            <th rowspan="2" style="width: 10%;">QUANT. DE ALIM. JÁ EM ESTOQUE (antes da entrega)</th>
                            <th rowspan="2" style="width: 7%;">SALDO ATUAL</th>
                            <th rowspan="2" style="width: 40%;">RELATÓRIO</th>
                            <th rowspan="2" style="width: 2%;"></th></tr>
                        <tr>
                            <th style="width: 7%;">QUANT.</th>
                            <th style="width: 17%;">DISCRIMINAÇÃO</th>
                        </tr>
                    </thead>
                    <tbody id="table-estoque-body">
                        </tbody>
                </table>
                <p style="text-align: right; margin-bottom: 30px;">Óbidos (PA), <span id="document_date_display">22 de agosto de 2025</span>.</p>
            </div>

            <div class="footer-document">
                <div class="signatures">
                    <div>
                        <hr>
                        <p>Diretor(a) da Escola</p>
                    </div>
                    <div>
                        <hr>
                        <p>Responsável pelo Depósito</p>
                    </div>
                    <div>
                        <hr>
                        <p>Responsável pelo preenchimento</p>
                    </div>
                </div>

                <div class="footer-semed">
                   <img id="rodape-imagem" src="rodape.png" alt="Rodapé Institucional">
                </div>
            </div>
            </div>

        </div>
    </div>
    <script>
        //PREENCHE TABELA 1
document.addEventListener('DOMContentLoaded', () => {
  function formatarDataString(dataInput) {
    if (!dataInput) return '';
    const partes = dataInput.split('-');
    if (partes.length !== 3) return '';
    return partes[2] + '/' + partes[1] + '/' + partes[0];
  }

  function atualizarTabela1() {
    const inicioStr = document.getElementById('periodo_inicio_input').value;
    const fimStr = document.getElementById('periodo_fim_input').value;

    // Validar se data final é menor que a inicial
    if (fimStr && inicioStr && fimStr < inicioStr) {
      alert('A data final não pode ser menor que a data inicial.');
      // Opcional: limpar a data final incorreta
      document.getElementById('periodo_fim_input').value = inicioStr;
      return; // interrompe o restante da função para evitar atualização errada
    }

    document.getElementById('nome_escola_display').textContent = document.getElementById('nome_escola_input').value;
    document.getElementById('endereco_escola_display').textContent = document.getElementById('endereco_escola_input').value;
    document.getElementById('meio_escola_display').textContent = document.getElementById('meio_escola_input').value;
    document.getElementById('municipio_escola_display').textContent = document.getElementById('municipio_escola_input').value;
    document.getElementById('num_alunos_display').textContent = document.getElementById('num_alunos_input').value;
    document.getElementById('tipo_ensino_display').textContent = document.getElementById('tipo_ensino_input').value;
    document.getElementById('periodo_display').innerHTML = `${formatarDataString(inicioStr)}<br>${formatarDataString(fimStr)}`;
  }

  const campos = [
    'nome_escola_input',
    'endereco_escola_input',
    'meio_escola_input',
    'municipio_escola_input',
    'num_alunos_input',
    'tipo_ensino_input',
    'periodo_inicio_input',
    'periodo_fim_input'
  ];

  campos.forEach(id => {
    const elemento = document.getElementById(id);
    elemento.addEventListener('input', atualizarTabela1);
    elemento.addEventListener('change', atualizarTabela1);
  });

  atualizarTabela1();
});
//[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]
//PREENCHE A DATA DO DOCUMENTO
function formatarDataPorExtenso(dataInput) {
  if (!dataInput) return '';
  const data = new Date(dataInput + 'T00:00:00'); // Criar data sem deslocamento
  const opcoes = { day: 'numeric', month: 'long', year: 'numeric' };
  return data.toLocaleDateString('pt-BR', opcoes);
}

function atualizarDataDocumento() {
  const dataDocumento = document.getElementById('document_date_input').value;
  document.getElementById('document_date_display').textContent = formatarDataPorExtenso(dataDocumento);
}

// Adicione este event listener para o input da data do documento
const inputDataDocumento = document.getElementById('document_date_input');
inputDataDocumento.addEventListener('input', atualizarDataDocumento);
inputDataDocumento.addEventListener('change', atualizarDataDocumento);

// Chame uma vez na inicialização para manter sincronizado
atualizarDataDocumento();
document.addEventListener('DOMContentLoaded', () => {
  // Função para formatar a data atual para YYYY-MM-DD
  function obterDataAtualISO() {
    const hoje = new Date();
    const ano = hoje.getFullYear();
    const mes = (hoje.getMonth() + 1).toString().padStart(2, '0');
    const dia = hoje.getDate().toString().padStart(2, '0');
    return `${ano}-${mes}-${dia}`;
  }

  // Define a data atual no input de data do documento
  const inputDataDocumento = document.getElementById('document_date_input');
  inputDataDocumento.value = obterDataAtualISO();

  // Chama função que atualiza a exibição da data do documento (supondo que já exista)
  atualizarDataDocumento();

  // Aqui o resto do seu código para atualizar tabela e listeners...
});
//[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]
//PREENCHIMENTO DA TABELA 2
document.addEventListener('DOMContentLoaded', () => {

  // Função para converter string dd/mm/yyyy para Date (para facilitar comparação)
  function parseDataBR(dataStr) {
    const [dia, mes, ano] = dataStr.split('/');
    return new Date(ano, mes - 1, dia);
  }

  // Formatar data para dd/mm/yyyy
  function formatarDataParaExibicao(dateObj) {
    const dia = String(dateObj.getDate()).padStart(2, '0');
    const mes = String(dateObj.getMonth() + 1).padStart(2, '0');
    const ano = dateObj.getFullYear();
    return `${dia}/${mes}/${ano}`;
  }

  // Variável global para armazenar os dados do cardápio
  let cardapioData = [];

  // Ler arquivo Excel e extrair dados da planilha do cardápio regular
  function lerArquivoExcel(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const sheetName = workbook.SheetNames[0]; // Considera primeira planilha
      const worksheet = workbook.Sheets[sheetName];
      const json = XLSX.utils.sheet_to_json(worksheet);
      cardapioData = json.map(item => ({
        ordem: item.ordem,
        dataBR: item['Dia/Mês/Ano'],
        diaSemana: item['Dia da semana'],
        cardapio: item['Cardápio'],
        segundaOpcao: item['2˚ Opção'],
        diasLetivos: (item['DIAS LETIVOS'] || "").toString().toUpperCase() === 'LETIVO'
      }));
      // Atualiza a tabela 2 se o cardápio estiver selecionado como Regular
      preencherTabela2();
    };
    reader.readAsArrayBuffer(file);
  }

  // Referência ao input do arquivo Excel no sidebar para leitura do arquivo
  const importCardapioInput = document.getElementById('import_file');

  importCardapioInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
      lerArquivoExcel(file);
    }
  });

  // Função que preenche a Tabela 2 com base no período e cardápio selecionado
  function preencherTabela2() {
    const periodoInicioStr = document.getElementById('periodo_inicio_input').value;
    const periodoFimStr = document.getElementById('periodo_fim_input').value;
    const tipoCardapio = document.querySelector('input[name="tipo_cardapio"]:checked').value;

    if (!periodoInicioStr || !periodoFimStr || !cardapioData.length) {
      return;  // Dados insuficientes para preencher
    }

    const periodoInicio = new Date(periodoInicioStr);
    const periodoFim = new Date(periodoFimStr);

    // Só consideramos o cardápio regular conforme especificado
    if (tipoCardapio !== 'regular') {
      // Limpar tabela 2 se for integral ou outros
      document.getElementById('table-cardapio-body').innerHTML = '';
      return;
    }

    // Filtrar somente dias dentro do período e que sejam letivos
    const diasFiltrados = cardapioData.filter(item => {
      const dataObj = parseDataBR(item.dataBR);
      return dataObj >= periodoInicio && dataObj <= periodoFim && item.diasLetivos;
    });

    const tbody = document.getElementById('table-cardapio-body');
    tbody.innerHTML = ''; // Limpar tabela antes de preencher

    diasFiltrados.forEach((item, index) => {
      const linha = document.createElement('tr');

      // Coluna 1: Quantidade de dias (número sequencial)
      const colNum = document.createElement('td');
      colNum.textContent = (index + 1);
      linha.appendChild(colNum);

      // Coluna 2: Frequência do dia (data)
      const colData = document.createElement('td');
      colData.textContent = item.dataBR;
      // Tornar a data editável no futuro, aqui pode ser transformado em input se necessário
      colData.contentEditable = "true";
      linha.appendChild(colData);

      // Colunas 3, 4, 5: Alunos atendidos (Creche, Ed. Inf e Fund, EJA) com X por padrão, editáveis
      ['creche', 'edInfFund', 'eja'].forEach(() => {
        const td = document.createElement('td');
        td.textContent = 'X';
        td.contentEditable = "true";
        td.style.textAlign = 'center';
        linha.appendChild(td);
      });

      // Coluna 6: Cardápio
      const colCardapio = document.createElement('td');
      const selectCardapio = document.createElement('select');
      // Opções - a primeira é o cardápio padrão, a segunda é a segunda opção, se existir
      const option1 = document.createElement('option');
      option1.value = item.cardapio;
      option1.text = item.cardapio;
      selectCardapio.appendChild(option1);

      if (item.segundaOpcao) {
        const option2 = document.createElement('option');
        option2.value = item.segundaOpcao;
        option2.text = item.segundaOpcao;
        selectCardapio.appendChild(option2);
      }
      colCardapio.appendChild(selectCardapio);
      linha.appendChild(colCardapio);

      // Coluna 7: Botão remover linha
      const colRemove = document.createElement('td');
      const btnRemove = document.createElement('button');
      btnRemove.textContent = '❌';
      btnRemove.title = 'Remover linha';
      btnRemove.onclick = () => {
        linha.remove();
        atualizarNumeracaoTabela2();
      };
      colRemove.appendChild(btnRemove);
      linha.appendChild(colRemove);

      // Coluna 8: Justificativa / Observação
      const colJustificativa = document.createElement('td');
      colJustificativa.textContent = 'X';
      colJustificativa.style.textAlign = 'center';
      colJustificativa.contentEditable = "true";

      // Se for sábado letivo, preencher justificativa automaticamente
      if (item.diaSemana.toLowerCase() === 'sábado') {
        colJustificativa.textContent = 'Sábado letivo, foi servida merenda escolar.';
      }
      linha.appendChild(colJustificativa);

      tbody.appendChild(linha);

      // Evento para alterar cardápio e preencher justificativa automaticamente
      selectCardapio.addEventListener('change', () => {
        const antigo = item.cardapio;
        const novo = selectCardapio.value;
        if (antigo !== novo) {
          colJustificativa.textContent = `O cardápio era "${antigo}" e foi substituído por "${novo}".`;
        }
      });

    });
  }

  // Atualiza a numeração sequencial da tabela 2 após remoção de linhas
  function atualizarNumeracaoTabela2() {
    const linhas = document.querySelectorAll('#table-cardapio-body tr');
    linhas.forEach((linha, idx) => {
      linha.cells[0].textContent = idx + 1;
    });
  }

  // Botão para gerar datas e cardápios (Tabela 2)
  const btnGerarTabela2 = document.querySelector('.sidebar button[onclick="generateTable2Rows()"]');
  if (btnGerarTabela2) {
    btnGerarTabela2.onclick = () => {
      preencherTabela2();
    };
  }

  // Também atualizar automaticamente se o período ou tipo de cardápio mudar
  document.getElementById('periodo_inicio_input').addEventListener('change', preencherTabela2);
  document.getElementById('periodo_fim_input').addEventListener('change', preencherTabela2);
  document.querySelectorAll('input[name="tipo_cardapio"]').forEach(radio => {
    radio.addEventListener('change', preencherTabela2);
  });

});
document.addEventListener('DOMContentLoaded', () => {
  // Seleciona o botão pelo seletor exato
  const btnGerarTabela2 = document.querySelector('.sidebar button[onclick="generateTable2Rows()"]');

  if (btnGerarTabela2) {
    btnGerarTabela2.addEventListener('click', (event) => {
      event.preventDefault();  // Previne qualquer comportamento padrão, se necessário
      preencherTabela2();
    });
  }

  // Função já criada para preencher a Tabela 2 com os dados do Excel e periodos
  function preencherTabela2() {
    // ... código da função que faz o preenchimento conforme previamente fornecido
  }

  // Outras funções, event listeners, e inicializações continuam aqui...
});
function generateTable2Rows() {
  preencherTabela2();
}

//
//
//
//
//
//
//

//
// Variável global para dados do cardápio
let cardapioData = [];

function parseDataBR(dataStr) {
  const [dia, mes, ano] = dataStr.split('/');
  return new Date(ano, mes - 1, dia);
}

function preencherTabela2() {
  const periodoInicioStr = document.getElementById('periodo_inicio_input').value;
  const periodoFimStr = document.getElementById('periodo_fim_input').value;
  const tipoCardapio = document.querySelector('input[name="tipo_cardapio"]:checked').value;

  if (!periodoInicioStr || !periodoFimStr || cardapioData.length === 0) {
    alert('Por favor, selecione o arquivo de cardápio e defina o período.');
    return;
  }

  if (tipoCardapio !== 'regular') {
    const tbody = document.getElementById('table-cardapio-body');
    tbody.innerHTML = '';
    return;
  }

  const periodoInicio = new Date(periodoInicioStr);
  const periodoFim = new Date(periodoFimStr);

  const diasFiltrados = cardapioData.filter(item => {
    const dataObj = parseDataBR(item['Dia/Mês/Ano']);
    return dataObj >= periodoInicio && dataObj <= periodoFim && (item['DIAS LETIVOS'] || "").toString().toUpperCase() === 'LETIVO';
  });

  const tbody = document.getElementById('table-cardapio-body');
  tbody.innerHTML = '';

  diasFiltrados.forEach((item, index) => {
    const linha = document.createElement('tr');

    const colNum = document.createElement('td');
    colNum.textContent = index + 1;
    linha.appendChild(colNum);

    const colData = document.createElement('td');
    colData.textContent = item['Dia/Mês/Ano'];
    colData.contentEditable = "true";
    linha.appendChild(colData);

    ['Creche', 'Ed. Inf. E Fundamental', 'EJA'].forEach(() => {
      const td = document.createElement('td');
      td.textContent = 'X';
      td.contentEditable = "true";
      td.style.textAlign = 'center';
      linha.appendChild(td);
    });

    const colCardapio = document.createElement('td');
    const select = document.createElement('select');

    const option1 = document.createElement('option');
    option1.value = item['Cardápio'];
    option1.text = item['Cardápio'];
    select.appendChild(option1);

    if (item['2˚ Opção']) {
      const option2 = document.createElement('option');
      option2.value = item['2˚ Opção'];
      option2.text = item['2˚ Opção'];
      select.appendChild(option2);
    }
    colCardapio.appendChild(select);
    linha.appendChild(colCardapio);

    const colRemove = document.createElement('td');
    const btnRemove = document.createElement('button');
    btnRemove.textContent = '❌';
    btnRemove.title = 'Remover linha';
    btnRemove.onclick = () => {
      linha.remove();
      atualizarNumeracaoTabela2();
    };
    colRemove.appendChild(btnRemove);
    linha.appendChild(colRemove);

    const colJustificativa = document.createElement('td');
    colJustificativa.textContent = (item['Dia da semana'] || '').toLowerCase() === 'sábado' ? 'Sábado letivo, foi servida merenda escolar.' : 'X';
    colJustificativa.style.textAlign = 'center';
    colJustificativa.contentEditable = "true";
    linha.appendChild(colJustificativa);

    select.addEventListener('change', () => {
      colJustificativa.textContent = `O cardápio era "${option1.value}" e foi substituído por "${select.value}".`;
    });

    tbody.appendChild(linha);
  });
}

function atualizarNumeracaoTabela2() {
  const linhas = document.querySelectorAll('#table-cardapio-body tr');
  linhas.forEach((linha, idx) => {
    linha.cells[0].textContent = idx + 1;
  });
}

function lerArquivoExcel(file) {
  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    cardapioData = XLSX.utils.sheet_to_json(worksheet);
    alert('Arquivo de cardápio carregado com sucesso!');
  };
  reader.readAsArrayBuffer(file);
}

document.getElementById('import_file').addEventListener('change', (event) => {
  const file = event.target.files[0];
  if (file) {
    lerArquivoExcel(file);
  }
});

// Função chamada pelo botão no sidebar
function generateTable2Rows() {
  preencherTabela2();
}

</script>

</body>
</html>