<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEMONSTRATIVO MENSAL MESTRE PACIFICO - DINÂMICO V5</title>
    <style>
        /* CONFIGURAÇÃO PARA ORIENTAÇÃO PAISAGEM (IMPRESSÃO) */
        @page {
            size: A4 landscape;
            margin: 10mm;
        }

        /* Estilos Globais e do Corpo do Documento */
        body {
            font-family: 'Times New Roman', serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0; 
            font-size: 10pt;
            color: #000;
        }

        /* ---------------------------------------------------- */
        /* SIDEBAR (PAINEL DE EDIÇÃO) - FIXA */
        /* ---------------------------------------------------- */
        .sidebar {
            background-color: #f7f7f7;
            border-right: 1px solid #ddd;
            padding: 15mm 15px; 
            font-size: 9pt;
            overflow-y: auto;
            position: fixed; 
            top: 0; 
            left: 0; 
            bottom: 0; 
            width: 320px; 
            z-index: 1000; 
            box-sizing: border-box;
        }

        .sidebar h4 {
            color: #004a99;
            border-bottom: 2px solid #004a99;
            padding-bottom: 5px;
            margin-top: 20px;
            font-size: 11pt;
        }
        .sidebar h5 {
            margin-top: 15px;
            margin-bottom: 5px;
            font-size: 10pt;
        }

        .sidebar label {
            display: block;
            font-weight: bold;
            margin-top: 10px;
            margin-bottom: 3px;
            font-size: 9pt;
        }

        .sidebar input[type="text"],
        .sidebar input[type="number"],
        .sidebar input[type="date"],
        .sidebar select {
            width: 95%;
            padding: 3px;
            border: 1px solid #aaa;
            border-radius: 3px;
            box-sizing: border-box;
            font-size: 8pt;
            margin-bottom: 5px;
        }
        .sidebar .date-pair {
            display: flex;
            justify-content: space-between;
        }
        .sidebar .date-pair input {
            width: 48%;
        }

        .sidebar button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 9pt;
            margin-top: 10px;
            cursor: pointer;
            border-radius: 4px;
        }
        .sidebar button:hover {
            background-color: #45a049;
        }
        /* Botões de adicionar linha mantidos na sidebar */
        .sidebar .add-row-btn {
             background-color: #004a99;
             margin-bottom: 5px;
        }
        .sidebar .add-row-btn:hover {
             background-color: #003066;
        }
        

        /* ---------------------------------------------------- */
        /* CONTEÚDO PRINCIPAL - AGORA FLUTUANTE */
        /* ---------------------------------------------------- */
        .main-content-area {
            margin-left: 320px; 
            padding: 0 30px; 
            min-height: 100vh;
        }

        .document-container {
            width: 297mm;
            min-height: 210mm;
            margin: 30px auto; 
            padding: 0mm 15mm;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            box-sizing: border-box;
        }

        /* Impede que a sidebar apareça na impressão */
        @media print {
            .sidebar {
                display: none;
            }
            .main-content-area {
                margin-left: 0;
            }
            .document-container {
                margin: 0;
                box-shadow: none;
            }
        }
        
        /* ---------------------------------------------------- */
        /* ESTILOS DE TABELA DINÂMICA */
        /* ---------------------------------------------------- */
        .data-table table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            margin-bottom: 15px;
        }
        .data-table th, .data-table td {
            border: 1px solid #000;
            padding: 2px;
            text-align: center;
            font-size: 7.5pt;
            word-break: break-word; 
            white-space: normal !important;
            vertical-align: middle;
        }
        .data-table th {
            font-weight: bold;
            background-color: #e0e0e0;
        }
        
        /* Adicionar estilos para o Timbre (Cabeçalho Institucional) */
        .header-institutional {
            text-align: center;
            margin-bottom: 20px; /* Espaço entre o timbre e o título */
            padding-top: 10px;
        }

        #timbre-imagem {
            max-width: 100%;
            display: block; /* Garante o alinhamento central */
        }
        /* Estilos para INPUTs e SELECTs dentro das CÉLULAS */
        .data-table input[type="text"],
        .data-table input[type="number"],
        .data-table input[type="date"],
        .data-table select {
            width: 90%;
            padding: 0;
            margin: 0;
            border: none;
            text-align: center;
            font-size: 7.5pt;
            background: transparent;
        }

        /* Tabela 2 - Estilo de Texto/Lista para Cardápio e Observações */
        #table-cardapio-body td:nth-child(6) select {
            width: 98%;
            text-align: left;
        }
        #table-cardapio-body td:nth-child(8) input {
             width: 98%;
             text-align: left;
        }
        
        /* NOVO: Estilo para centralizar número e unidade na mesma linha (Tabela 3) */
        #tabela-estoque .quantity-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        #tabela-estoque .quantity-cell input {
            width: 70%; 
            text-align: right;
            padding-right: 2px;
        }
        #tabela-estoque .quantity-cell .unit {
            width: 30%;
            text-align: left;
            padding-left: 2px;
        }
        /* Ajuste específico para a descrição do gênero */
        #tabela-estoque td:nth-child(2) select {
            width: 98%;
            text-align: left;
        }


        /* Estilo para o botão de remoção */
        .remove-row-btn {
            background: none;
            border: none;
            color: red;
            cursor: pointer;
            font-size: 10pt;
            padding: 0 2px;
            line-height: 1;
        }
        .remove-row-btn:hover {
            color: darkred;
        }

        /* ---------------------------------------------------- */
        /* ESTILOS DO DOCUMENTO (MANTIDOS/AJUSTADOS) */
        /* ---------------------------------------------------- */
        
        #tabela-detalhes td {
            height: 30px; 
            vertical-align: middle;
        }
        #tabela-estoque th, #tabela-estoque td {
            text-align: left;
        }
        #tabela-estoque td:nth-child(1), #tabela-estoque td:nth-child(3), #tabela-estoque td:nth-child(4), #tabela-estoque td:nth-child(5) {
            text-align: center;
        }
        .footer-document {
            margin-top: 50px;
            padding-top: 10px;
        }
        .signatures {
            display: flex;
            justify-content: space-around;
            text-align: center;
            margin-bottom: 20px;
        }
        .signatures div {
            width: 30%;
        }
        .signatures hr {
            border: 0;
            border-top: 1px solid #000;
            margin-bottom: 5px;
        }
        #tabela-detalhes span {
            display: block;
            width: 100%;
        }

        /* Adicionar estilos para o Rodapé Institucional */
        .footer-semed {
            text-align: center;
            margin-top: 15px; /* Espaçamento entre as assinaturas e o rodapé */
        }

        #rodape-imagem {
            width: 100%; /* Garante que o rodapé ocupe a largura total do container */
            display: block;
        }
        
        /* 1. Permite que as linhas da tabela cresçam conforme o conteúdo */
        #table-cardapio-body tr,
        #table-estoque-body tr {
            height: auto !important;
        }

        /* 2. Estilo para as células clicáveis */
        #table-cardapio-body td:nth-child(6), /* Cardápio */
        #table-cardapio-body td:nth-child(8), /* Justificativa */
        #table-estoque-body td:nth-child(6) { /* Relatório */
            vertical-align: top;
            padding: 0; /* Remove padding para melhor controle da tag p */
            cursor: pointer; /* Indica que a célula é clicável */
        }

        /* 3. Estilo para a tag <p> (Modo de visualização) */
        #table-cardapio-body td p,
        #table-estoque-body td p {
            margin: 0;
            min-height: 10px; /* Altura mínima para não colapsar a linha */
            padding: 4px 5px;
            border: 1px solid transparent; 
            transition: background-color 0.2s;
            text-align: left;
            white-space: pre-wrap; /* Permite quebras de linha e texto envolvente */
        }

        /* Efeito visual ao passar o mouse */
        #table-cardapio-body td:hover p,
        #table-estoque-body td:hover p {
            background-color: #f0f0f0;
        }

        /* 4. Estilos para os campos dinâmicos (Modo de edição) */
        #table-cardapio-body select.edit-field,
        #table-cardapio-body textarea.edit-field,
        #table-estoque-body textarea.edit-field {
            width: 100%;
            height: auto; /* Altura controlada pelo JS */
            box-sizing: border-box;
            padding: 2px;
            margin: 0;
            border: 1px solid #000;
            resize: vertical; /* Permite que o usuário redimensione a altura */
            min-height: 40px; 
            overflow-y: hidden;
            line-height: 1.2;
        }

        /* Garante que o select ocupe a altura mínima para ser visível */
        #table-cardapio-body select.edit-field {
            min-height: 30px;
        }
        
        /* 5. Centralização para conteúdo vazio (NOVA REGRA) */
        #table-cardapio-body td .center-if-empty,
        #table-estoque-body td .center-if-empty {
            text-align: center !important;
        }
        
    </style>
</head>
<body>

    <div class="sidebar">
        <h4>1. Detalhes da Escola (Tabela 1)</h4>

        <label for="nome_escola_input">NOME DA ESCOLA</label>
        <select id="nome_escola_input">
            <option value="Escola Mestre Pacífico" selected>Escola Mestre Pacífico</option>
            <option value="Escola João Fernandes de Oliveira">Escola João Fernandes de Oliveira</option>
            <option value="Escola Marilda Carvalho">Escola Marilda Carvalho</option>
            <option value="Escola Raimundo Pereira">Escola Raimundo Pereira</option>
            <option value="Escola Mestre Pacífico - CEMEP">Escola Mestre Pacífico - CEMEP</option>
            <option value="Escola Mestre Pacífico - INTEGRAL">Escola Mestre Pacífico - INTEGRAL</option>
        </select>

        <label for="endereco_escola_input">ENDEREÇO</label>
        <select id="endereco_escola_input">
            <option value="Comunidade Igarapé Açu" selected>Comunidade Igarapé Açu</option>
            <option value="Comunidade Ipixuna">Comunidade Ipixuna</option>
            <option value="Comunidade Arumã">Comunidade Arumã</option>
        </select>
        
        <label for="meio_escola_input">MEIO</label>
        <select id="meio_escola_input">
            <option value="Terra Firme" selected>Terra Firme</option>
        </select>

        <label for="municipio_escola_input">MUNICÍPIO</label>
        <select id="municipio_escola_input">
            <option value="Óbidos" selected>Óbidos</option>
        </select>

        <label for="num_alunos_input">N° DE ALUNOS MATRICULADOS</label>
        <input type="number" id="num_alunos_input" value="330">
        
        <label for="tipo_ensino_input">TIPO DE ENSINO</label>
        <select id="tipo_ensino_input">
            <option value="Ed. Inf. E Ens. Fund." selected>Ed. Inf. E Ens. Fund.</option>
            <option value="Ed. Infantil">Ed. Infantil</option>
            <option value="Ens. Fundamental">Ens. Fundamental</option>
        </select>
        <h5>Seleção de Cardápio</h5>
        <div style="margin-bottom: 10px; display: flex; justify-content: space-around;">
            <div>
                <input type="radio" id="cardapio_regular" name="tipo_cardapio" value="regular" checked>
                <label for="cardapio_regular" style="display: inline; width: auto; margin-left: 5px;">Regular</label>
            </div>
            <div>
                <input type="radio" id="cardapio_integral" name="tipo_cardapio" value="integral">
                <label for="cardapio_integral" style="display: inline; width: auto; margin-left: 5px;">Integral</label>
            </div>
        </div>
        
        <label for="periodo_input">PERÍODO (Início e Fim) - Gera as datas da Tabela 2</label>
        <div class="date-pair">
            <input type="date" id="periodo_inicio_input" value="2025-09-01" onchange="generateTable2Rows()">
            <input type="date" id="periodo_fim_input" value="2025-09-30" onchange="generateTable2Rows()">
        </div>
        <button onclick="generateTable2Rows()">Gerar Datas e Cardápios (Tabela 2)</button>

        
        <hr style="margin-top: 20px;">
        
        <h5>Data do Documento</h5>
        <input type="date" id="document_date_input" class="data-input">

        <hr style="margin-top: 20px;">

        <h5>Gerenciamento de Linhas</h5>
        <button class="add-row-btn" onclick="addRowTable2()">+ Adicionar Linha (Tabela 2)</button>
        <button class="add-row-btn" onclick="addRowTable3()">+ Adicionar Linha (Tabela 3)</button>

        <h5>Gerenciamento de Dados</h5>
        <button class="generate-btn" onclick="exportDataToTEXT()" style="background-color: #f7931e;">
            Exportar Dados (Planilha)
        </button>
        <input type="file" id="import_file" accept=".txt" style="margin-bottom: 5px;">
        <button class="generate-btn" onclick="document.getElementById('import_file').click()" style="background-color: #5cb85c; margin-top: 0;">
            Selecionar Arquivo
        </button>
        <button class="generate-btn" onclick="importDataFromTEXT()" style="background-color: #337ab7; margin-top: 5px;">
            Importar Dados
        </button>

        <p style="font-size: 8pt; margin-top: 20px;">*A Tabela 3 é preenchida automaticamente com os itens do cardápio.</p>
        <button onclick="window.print()" style="background-color: #d9534f; margin-top: 20px;">
            &#x1F5B6; Imprimir Documento (A4 Paisagem)
        </button>
    </div>
    <div class="main-content-area">
        <div class="document-container">

            <div class="header-institutional">
                <img id="timbre-imagem" src="timbre.png" alt="Logotipo da Instituição">
            </div>

            <h2 style="text-align: center; font-size: 11pt; margin: 10px 0; text-decoration: underline;">DEMONSTRATIVO MENSAL DA DISTRIBUIÇÃO DE REFEIÇÕES E CONSUMO DE GÊNEROS ALIMENTÍCIOS NA ESCOLA</h2>

            <div class="data-table">
                <table id="tabela-detalhes">
                    <thead>
                        <tr>
                            <th style="width: 15%;">NOME DA ESCOLA</th>
                            <th style="width: 18%;">ENDEREÇO</th>
                            <th style="width: 8%;">MEIO</th>
                            <th style="width: 10%;">MUNICÍPIO</th>
                            <th style="width: 13%;">DEPENDÊNCIA ADMINISTRATIVA</th>
                            <th style="width: 10%;">N° DE ALUNOS MATRICULADOS</th>
                            <th style="width: 13%;">TIPO DE ENSINO</th>
                            <th style="width: 13%;">PERÍODO</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span id="nome_escola_display">Escola Mestre Pacífico</span></td>
                            <td><span id="endereco_escola_display">Comunidade Igarapé Açu</span></td>
                            <td><span id="meio_escola_display">Terra Firme</span></td>
                            <td><span id="municipio_escola_display">Óbidos</span></td>
                            <td>Municipal</td>
                            <td><span id="num_alunos_display">330</span></td>
                            <td><span id="tipo_ensino_display">Ed. Inf. E Ens. Fund.</span></td>
                            <td><span id="periodo_display">01/09/2025<br>30/09/2025</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="data-table">
                <table class="table-cardapio">
                    <thead>
                        <tr>
                            <th rowspan="2" style="width: 3%;">QUANT. DIAS</th>
                            <th rowspan="2" style="width: 9%;">FREQ. DO DIA/<br>DATA</th>
                            <th colspan="3">ALUNOS ATENDIDOS</th>
                            <th rowspan="2" style="width: 35%;">CARDÁPIO</th>
                            <th rowspan="2" style="width: 2%;"></th>
                            <th rowspan="2" style="width: 34%;">JUSTIFICATIVA / OBSERVAÇÃO</th>
                        </tr>
                        <tr>
                            <th style="width: 8%;">CRECHE</th>
                            <th style="width: 11%;">ED. INF. E FUNDAMENTAL</th>
                            <th style="width: 8%;">EJA</th>
                        </tr>
                    </thead>
                    <tbody id="table-cardapio-body">
                        </tbody>
                </table>
            </div>
            
            <div class="data-table">
                <h3 style="text-align: center; font-size: 10pt; font-weight: bold; margin-bottom: 5px;">CONTROLE DE GÊNEROS ALIMENTÍCIOS</h3>
                <table id="tabela-estoque">
                    <thead>
                        <tr>
                            <th colspan="2" style="width: 20%;">GÊNEROS RECEBIDOS DO PROGRAMA</th>
                            <th rowspan="2" style="width: 6%;">QUANT. DE ALIM. CONS.</th>
                            <th rowspan="2" style="width: 10%;">QUANT. DE ALIM. JÁ EM ESTOQUE (antes da entrega)</th>
                            <th rowspan="2" style="width: 7%;">SALDO ATUAL</th>
                            <th rowspan="2" style="width: 40%;">RELATÓRIO</th>
                            <th rowspan="2" style="width: 2%;"></th></tr>
                        <tr>
                            <th style="width: 7%;">QUANT.</th>
                            <th style="width: 17%;">DISCRIMINAÇÃO</th>
                        </tr>
                    </thead>
                    <tbody id="table-estoque-body">
                        </tbody>
                </table>
                <p style="text-align: right; margin-bottom: 30px;">Óbidos (PA), <span id="document_date_display">22 de agosto de 2025</span>.</p>
            </div>

            <div class="footer-document">
                <div class="signatures">
                    <div>
                        <hr>
                        <p>Diretor(a) da Escola</p>
                    </div>
                    <div>
                        <hr>
                        <p>Responsável pelo Depósito</p>
                    </div>
                    <div>
                        <hr>
                        <p>Responsável pelo preenchimento</p>
                    </div>
                </div>

                <div class="footer-semed">
                   <img id="rodape-imagem" src="rodape.png" alt="Rodapé Institucional">
                </div>
            </div>
            </div>

        </div>
    </div>
<!--1.2--><script>
        const UNITS = {
            'Açúcar triturado': 'kg', 'Arroz tipo 1': 'kg', 'Biscoito salgado cream cracker': 'pcts',
            'Carne moída': 'kg', 'Leite em pó integral': 'pcts', 'Peito de frango': 'kg',
            'Feijão tipo 1': 'kg', 'Alho in natura': 'kg', 'Batata in natura': 'kg', 
            'Café em pó': 'pcts', 'Carne sem osso': 'kg', 'Cebola in natura': 'kg', 
            'Cenoura in natura': 'kg', 'Colorau': 'pcts', 'Coco ralado': 'pcts', 
            'Cominho moído': 'pcts', 'Farinha de trigo': 'kg', 'Macarrão espaguete': 'pcts', 
            'Óleo de soja 900ml': 'pets', 'Polpa de frutas': 'pcts', 'Milho Branco': 'pcts',
            'Azeite de dendê': 'grfs', 'Vinagre de álcool': 'grfs', 'Massa para sopa': 'pcts', 
            'Sal moído': 'kg', 'Mingau de banana grande': 'un', 'Filé de peixe desfiado com arroz': 'un',
            'Frango desfiado com arroz': 'un', 'Suco de fruta com pão e carne moída': 'un', 
            'Suco de fruta com biscoito salgado': 'un', 'OUTRO (a ser especificado)': 'un'
        };

        const CALENDARIO_LETIVO_2025 = {
            ano_inicio: '2025-02-10',
            ano_fim: '2025-12-23',
            nao_letivos: [
                '2025-03-04', '2025-03-05', 
                '2025-05-01',
                '2025-06-19',
                '2025-08-15',
                '2025-10-02', '2025-10-15', '2025-10-28',
                '2025-11-20',
            ].reduce((acc, date) => { acc[date] = true; return acc; }, {}),
            sabadosLetivos: [
                '2025-05-03', '2025-05-17',
                '2025-06-07', '2025-06-28',
                '2025-07-05', '2025-07-19',
                '2025-08-02', '2025-08-23',
                '2025-09-06', '2025-09-20',
                '2025-10-04', '2025-10-18',
                '2025-11-08', '2025-11-22',
                '2025-12-06', '2025-12-20',
            ].reduce((acc, date) => { acc[date] = true; return acc; }, {}),
            diasLetivosMarco: [
                '2025-03-03', '2025-03-06', '2025-03-07', '2025-03-10', '2025-03-11', 
                '2025-03-12', '2025-03-13', '2025-03-14'
            ].reduce((acc, date) => { acc[date] = true; return acc; }, {}),
        };
        
        const CARDAPIO_REGULAR = {
            1: {
                1: "Café com leite e biscoito salgado",
                2: "Frango desfiado com arroz branco",
                3: "Sopa de feijão com carne",
                4: "Mingau de milho branco",
                5: "Carne moída com macarrão",
            },
            2: {
                1: "Mingau de farinha de tapioca",
                2: "Carne moída com macarrão",
                3: "Feijão com carne, arroz branco e verduras",
                4: "Suco de fruta com biscoito salgado",
                5: "Batapá de frango",
            },
            3: {
                1: "Café com leite e biscoito salgado",
                2: "Frango desfiado e arroz branco",
                3: "Sopa de feijão com carne e verduras",
                4: "Mingau de milho branco",
                5: "Filé de peixe desfiado com arroz",
            },
            4: {
                1: "Mingau de farinha de tapioca",
                2: "Carne moída com macarrão",
                3: "Feijão de carne com arroz branco",
                4: "Suco de fruta com pão e carne moída",
                5: "Vatapá de frango",
            },
            sabado: "Café com leite, biscoito e salgado",
        };
        
        const CARDAPIO_INTEGRAL = {
            1: {
                1: "Café com leite, pão e queijo (Manhã) | Frango desfiado e Arroz com Salada (Almoço)",
                2: "Mingau de aveia (Manhã) | Feijão, Arroz, Carne Moída e Legumes (Almoço)",
                3: "Suco de fruta e Biscoito (Manhã) | Sopa reforçada com carne e macarrão (Almoço)",
                4: "Iogurte e fruta (Manhã) | Peito de frango assado, purê de batata e suco (Almoço)",
                5: "Café com leite e bolo (Manhã) | Carne de panela, macarrão e verduras (Almoço)",
            },
            2: {
                1: "Mingau de farinha de tapioca (Manhã) | Carne moída, Arroz e Salada (Almoço)",
                2: "Café com leite e biscoito salgado (Manhã) | Feijão com carne, arroz branco e verduras (Almoço)",
                3: "Pão com ovo e fruta (Manhã) | Vatapá de frango com arroz (Almoço)",
                4: "Suco de fruta com pão e carne moída (Manhã) | Peixe ensopado com legumes e farofa (Almoço)",
                5: "Mingau de milho branco (Manhã) | Strogonoff de frango e arroz (Almoço)",
            },
            3: CARDAPIO_REGULAR[3], 
            4: CARDAPIO_REGULAR[4], 
            sabado: "Almoço especial de sábado letivo: Feijoada leve com arroz.",
        };


        const ALL_CARDAPIOS_RAW = [
            ...Object.values(CARDAPIO_REGULAR[1]),
            ...Object.values(CARDAPIO_REGULAR[2]),
            ...Object.values(CARDAPIO_REGULAR[3]),
            ...Object.values(CARDAPIO_REGULAR[4]),
            CARDAPIO_REGULAR.sabado,
            ...Object.values(CARDAPIO_INTEGRAL[1]),
            ...Object.values(CARDAPIO_INTEGRAL[2]),
            CARDAPIO_INTEGRAL.sabado,
            "Mingau de banana grande", 
            "Frango desfiado com arroz", 
            "Suco de fruta com pão e carne moída", 
            "Suco de fruta com biscoito salgado", 
        ];
        const CARDAPIO_OPTIONS = [...new Set(ALL_CARDAPIOS_RAW)].sort();
        
        let currentCardapioType = 'regular'; 
        
        function syncSidebarToTable1() {
            document.getElementById('nome_escola_display').textContent = document.getElementById('nome_escola_input').value;
            document.getElementById('endereco_escola_display').textContent = document.getElementById('endereco_escola_input').value;
            document.getElementById('meio_escola_display').textContent = document.getElementById('meio_escola_input').value;
            document.getElementById('municipio_escola_display').textContent = document.getElementById('municipio_escola_input').value;
            document.getElementById('num_alunos_display').textContent = document.getElementById('num_alunos_input').value;
            document.getElementById('tipo_ensino_display').textContent = document.getElementById('tipo_ensino_input').value;

            const inicio = document.getElementById('periodo_inicio_input').value;
            const fim = document.getElementById('periodo_fim_input').value;
            const inicioDisplay = inicio ? formatDateToDisplay(inicio) : '';
            const fimDisplay = fim ? formatDateToDisplay(fim) : '';
            document.getElementById('periodo_display').innerHTML = `${inicioDisplay}<br>${fimDisplay}`;
        }

        function updateDocumentDate() {
            const dateInput = document.getElementById('document_date_input').value;
            if (dateInput) {
                const dateObj = new Date(dateInput + 'T00:00:00');
                const options = { day: 'numeric', month: 'long', year: 'numeric' };
                const formattedDate = dateObj.toLocaleDateString('pt-BR', options);
                document.getElementById('document_date_display').textContent = formattedDate;
            }
        }

        function formatDateToDisplay(dateString) {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }
        
        function getWeekOfMonth(date) {
            const d = new Date(date.getTime());
            d.setDate(1); 
            
            let firstMonday = new Date(date.getFullYear(), date.getMonth(), 1);
            while (firstMonday.getDay() !== 1) { 
                firstMonday.setDate(firstMonday.getDate() + 1);
            }
            
            let week = 1;
            let tempDate = new Date(firstMonday.getTime());
            
            while (tempDate <= date) {
                if (tempDate.getDay() === 1 && tempDate.toDateString() !== firstMonday.toDateString()) {
                    week++;
                }
                
                if (tempDate.toDateString() === date.toDateString()) {
                    return (week - 1) % 4 + 1;
                }
                
                tempDate.setDate(tempDate.getDate() + 1);
            }
            
            return 1;
        }

        function getCardapioForDate(date) {
            const dateISO = date.toISOString().substring(0, 10);
            const dayOfWeek = date.getDay();
            
            const CARDAPIOS_SELECIONADOS = currentCardapioType === 'integral' ? CARDAPIO_INTEGRAL : CARDAPIO_REGULAR;

            if (dayOfWeek === 6 && CALENDARIO_LETIVO_2025.sabadosLetivos[dateISO]) {
                return CARDAPIOS_SELECIONADOS.sabado;
            }

            if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                const weekOfMonth = getWeekOfMonth(date);
                const effectiveWeek = (weekOfMonth > 4) ? (weekOfMonth - 1) % 4 + 1 : weekOfMonth;
                const dayIndex = dayOfWeek;
                
                const weekCardapio = CARDAPIOS_SELECIONADOS[effectiveWeek];
                
                return weekCardapio ? weekCardapio[dayIndex] : "Cardápio Indefinido";
            }

            return null; 
        }

        function isLetivo(date) {
            const dateISO = date.toISOString().substring(0, 10);
            const dayOfWeek = date.getDay();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();

            const schoolStart = new Date(CALENDARIO_LETIVO_2025.ano_inicio + 'T00:00:00');
            const schoolEnd = new Date(CALENDARIO_LETIVO_2025.ano_fim + 'T00:00:00');
            if (date < schoolStart || date > schoolEnd) {
                return false;
            }

            if (CALENDARIO_LETIVO_2025.nao_letivos[dateISO]) {
                return false;
            }
            
            if (month === 4) {
                return false;
            }

            if (dayOfWeek === 0) {
                return false;
            }
            
            if (month === 3) {
                return CALENDARIO_LETIVO_2025.diasLetivosMarco[dateISO] || false;
            }

            if (dayOfWeek === 6) {
                return CALENDARIO_LETIVO_2025.sabadosLetivos[dateISO] || false;
            }
            
            return dayOfWeek >= 1 && dayOfWeek <= 5;
        }


        function validateAttendance(input) {
            const row = input.closest('tr');
            const maxAlunos = parseInt(document.getElementById('num_alunos_input').value) || 0;
            
            if (maxAlunos === 0) return;

            const inputs = Array.from(row.cells).slice(2, 5).map(cell => cell.querySelector('input[type="number"]'));
            let currentSum = 0;
            
            inputs.forEach(inp => {
                const val = inp.value;
                if (val.toUpperCase() !== 'X' && !isNaN(parseInt(val))) {
                    currentSum += parseInt(val);
                }
            });

            if (currentSum > maxAlunos) {
                alert(`A soma de alunos (${currentSum}) excede o total matriculado (${maxAlunos}).`);
                input.value = 'X'; 
            }
            
            formatAttendance(input);
        }
        
        function formatAttendance(input) {
            if (input.value === '' || input.value === '0' || input.value.toUpperCase() === 'X') {
                input.value = 'X';
            }
        }
        
        function handleCardapioChange(selectElement) {
            const row = selectElement.closest('tr');
            const dateInput = row.cells[1].querySelector('input[type="date"]');
            
            const justificativaCell = row.cells[7]; 
            const justificativaP = justificativaCell.querySelector('p');
            
            // Se o campo estiver em modo de edição (textarea), pega o valor de lá. Caso contrário, pega do <p>
            const justificativaInput = justificativaCell.querySelector('textarea') || {value: justificativaP ? justificativaP.textContent.replace(/<br>/g, '\n') : '-'};
            
            const dateISO = dateInput.value;
            const selectedCardapio = selectElement.value;
            
            const dateObj = new Date(dateISO + 'T00:00:00');
            const cardapioPrevisto = getCardapioForDate(dateObj);
            
            const dateDisplay = formatDateToDisplay(dateISO);
            const isSabadoLetivo = dateObj.getDay() === 6 && CALENDARIO_LETIVO_2025.sabadosLetivos[dateISO];
            const sabadoJust = `No dia ${dateDisplay}, sábado letivo, foi servida merenda`;
            
            let newJustificativa = justificativaInput.value;


            if (cardapioPrevisto && selectedCardapio !== cardapioPrevisto) {
                
                const novaJustificativa = `No dia ${dateDisplay} o cardápio previsto era "${cardapioPrevisto}", foi substituido por `;
                
                if (!justificativaInput.value.trim() || justificativaInput.value.trim() === sabadoJust || justificativaInput.value.trim() === '-') {
                    alert(`Atenção: O cardápio original de ${dateDisplay} era "${cardapioPrevisto}" e foi alterado para "${selectedCardapio}". Por favor, justifique no campo ao lado.`);
                    newJustificativa = novaJustificativa;
                }

            } else if (cardapioPrevisto && selectedCardapio === cardapioPrevisto) {
                if (justificativaInput.value.includes('o cardápio previsto era')) {
                    newJustificativa = isSabadoLetivo ? sabadoJust : '-';
                } else if (isSabadoLetivo) {
                    newJustificativa = sabadoJust;
                } else {
                    newJustificativa = '-';
                }
            }
            
            if (justificativaCell.querySelector('textarea')) {
                justificativaInput.value = newJustificativa;
                autoGrowTextarea(justificativaCell.querySelector('textarea'));
            } else if (justificativaP) {
                justificativaP.innerHTML = newJustificativa.replace(/\n/g, '<br>');
                // NEW: apply centering logic after change
                const rawValue = newJustificativa.trim();
                if (rawValue === '-' || rawValue === '' || rawValue === '0') {
                    justificativaP.classList.add('center-if-empty');
                } else {
                    justificativaP.classList.remove('center-if-empty');
                }
            }
        }

        function updateRowNumbers() {
            const rows = document.getElementById('table-cardapio-body').querySelectorAll('tr');
            rows.forEach((row, index) => {
                const numCell = row.querySelector('.row-number');
                if (numCell) {
                    numCell.textContent = index + 1;
                }
            });
        }
        
        // --- NOVO: Lógica de Edição Dinâmica ---

        function autoGrowTextarea(textarea) {
            if (!textarea) return;
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight + 5) + 'px';
            const minHeight = 40; 
            if (textarea.scrollHeight < minHeight) {
                textarea.style.height = minHeight + 'px';
            }
        }

        function saveEdit(element) {
            const cell = element.closest('td');
            let newValue;
            let pContent;

            if (element.tagName === 'SELECT') {
                newValue = element.value;
                pContent = newValue;
                handleCardapioChange(element); // Trigger change detection
            } else if (element.tagName === 'TEXTAREA') {
                newValue = element.value.trim() || '-';
                pContent = newValue.replace(/\n/g, '<br>'); // Preserve line breaks for display
                
                // If it's a T3 textarea, update the balance calculation
                if (cell.closest('#table-estoque-body')) {
                    updateTable3Row(element);
                }
            } else {
                return;
            }

            if (element.tagName === 'SELECT') {
                newValue = element.value;
                pContent = newValue;
                rawValue = newValue.trim(); // <--- NOVO
                handleCardapioChange(element); 
            } else if (element.tagName === 'TEXTAREA') {
                newValue = element.value.trim() || '-';
                pContent = newValue.replace(/\n/g, '<br>'); 
                rawValue = newValue.trim(); // <--- NOVO
                
                if (cell.closest('#table-estoque-body')) {
                    updateTable3Row(element);
                }
            } else {
                return;
            }

            // Replace the input/select with the new <p> tag
            const newP = document.createElement('p');
            newP.innerHTML = pContent;
            newP.title = element.title; 
            
            // Core centering logic: Center if content is essentially empty or just the placeholder
            if (rawValue === '-' || rawValue === '' || rawValue === '0') {
                newP.classList.add('center-if-empty');
            } 

            // Re-attach the correct click listener based on the column index
            if (cell.cellIndex === 5 && cell.closest('#table-cardapio-body')) { // T2, Col 6 (Index 5) - Cardápio
                newP.onclick = () => enableCardapioEdit(cell);
            } else if (cell.cellIndex === 7 && cell.closest('#table-cardapio-body')) { // T2, Col 8 (Index 7) - Justificativa
                newP.onclick = () => enableTextEdit(cell);
            } else if (cell.cellIndex === 5 && cell.closest('#table-estoque-body')) { // T3, Col 6 (Index 5) - Relatório
                newP.onclick = () => enableTextEdit(cell);
            }

            cell.innerHTML = '';
            cell.appendChild(newP);
        }

        function enableCardapioEdit(cell) {
            // Prevent editing if already editing
            if (cell.querySelector('.edit-field')) return;
            
            const currentValue = cell.querySelector('p').textContent;
            const optionsHTML = CARDAPIO_OPTIONS.map(opt => 
                `<option value="${opt}" ${opt === currentValue ? 'selected' : ''}>${opt}</option>`
            ).join('');

            const select = document.createElement('select');
            select.innerHTML = optionsHTML;
            select.value = currentValue;
            select.className = 'edit-field';

            // Save the edit when the selection changes or focus is lost
            select.onchange = () => saveEdit(select);
            select.onblur = (e) => {
                // Check if the related target is not part of the current cell (e.g., clicking a button elsewhere)
                if (!e.relatedTarget || !cell.contains(e.relatedTarget)) {
                    saveEdit(select);
                }
            }; 

            cell.innerHTML = '';
            cell.appendChild(select);
            select.focus();
        }

        function enableTextEdit(cell) {
            // Prevent editing if already editing
            if (cell.querySelector('.edit-field')) return;

            const currentP = cell.querySelector('p');
            // Read the content of the P tag (replace <br> back to \n for editing)
            const currentValue = currentP.innerHTML.replace(/<br>/g, '\n');
            
            const textarea = document.createElement('textarea');
            textarea.value = currentValue.trim() === '-' ? '' : currentValue.trim();
            textarea.className = 'edit-field';
            
            // Auto-grow on input
            textarea.oninput = () => autoGrowTextarea(textarea);

            // Save the edit when focus is lost (tab, click outside)
            textarea.onblur = (e) => {
                if (!e.relatedTarget || !cell.contains(e.relatedTarget)) {
                    saveEdit(textarea);
                }
            };
            
            // Save on 'Enter' (but allow Shift+Enter for new line)
            textarea.onkeydown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    saveEdit(textarea);
                    e.target.blur(); // Remove focus after saving
                }
            };
            
            cell.innerHTML = '';
            cell.appendChild(textarea);
            
            // Immediately auto-grow and focus
            autoGrowTextarea(textarea);
            textarea.focus();
        }
        
        // --- FIM: Lógica de Edição Dinâmica ---


        function generateTable2Rows() {
            const tbody = document.getElementById('table-cardapio-body');
            const inicioInput = document.getElementById('periodo_inicio_input').value;
            const fimInput = document.getElementById('periodo_fim_input').value;

            syncSidebarToTable1();
            
            if (!inicioInput || !fimInput) {
                alert("Por favor, defina as datas de início e fim do período.");
                return;
            }

            const startDate = new Date(inicioInput + 'T00:00:00');
            const endDate = new Date(fimInput + 'T00:00:00');

            if (startDate > endDate) {
                alert("A data de início deve ser anterior ou igual à data de fim.");
                return;
            }
            
            tbody.innerHTML = '';
            let currentDate = startDate;

            while (currentDate <= endDate) {
                const dateISO = currentDate.toISOString().substring(0, 10);
                
                if (isLetivo(currentDate)) {
                    const newRow = tbody.insertRow();
                    const dateDisplay = formatDateToDisplay(dateISO);
                    
                    const cardapioPrevisto = getCardapioForDate(currentDate);
                    const isSabadoLetivo = currentDate.getDay() === 6;
                    
                    let justificativaInicial = '-';
                    if (isSabadoLetivo) {
                        justificativaInicial = `No dia ${dateDisplay}, sábado letivo, foi servida merenda`;
                    }
                    
                    // Cardápio (Col 6): Não centraliza por padrão, pois sempre tem conteúdo não vazio
                    const cardapioCellContent = `<p onclick="enableCardapioEdit(this.parentNode)">${cardapioPrevisto}</p>`;
                    
                    // Justificativa (Col 8): Centraliza se o conteúdo inicial for o placeholder '-'
                    const justificativaPContent = justificativaInicial.replace(/\n/g, '<br>');
                    const isJustificativaCentered = justificativaInicial.trim() === '-' || justificativaInicial.trim() === '';
                    const justificativaCellContent = `<p onclick="enableTextEdit(this.parentNode)" class="${isJustificativaCentered ? 'center-if-empty' : ''}">${justificativaPContent}</p>`;
                    
                    let rowHTML = `
                        <td class="row-number"></td>
                        <td><input type="date" value="${dateISO}"></td>
                        <td><input type="number" value="X" oninput="validateAttendance(this)"></td>
                        <td><input type="number" value="X" oninput="validateAttendance(this)"></td>
                        <td><input type="number" value="X" oninput="validateAttendance(this)"></td>
                        <td>${cardapioCellContent}</td>
                        <td><button class="remove-row-btn" onclick="removeRow(this, 'table-cardapio-body')">&#128465;</button></td>
                        <td>${justificativaCellContent}</td>
                    `;

                    newRow.innerHTML = rowHTML;
                    
                    // Initial formatting for attendance inputs
                    newRow.querySelectorAll('input[type="number"]').forEach(input => formatAttendance(input));
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            updateRowNumbers();
        }
        
        function addRowTable2() {
            const tbody = document.getElementById('table-cardapio-body');
            const newRow = tbody.insertRow();

            // Cardápio (Col 6): Não centraliza por padrão
            const cardapioCellContent = `<p onclick="enableCardapioEdit(this.parentNode)">${CARDAPIO_OPTIONS[0]}</p>`;
            // Justificativa (Col 8): Centraliza o placeholder
            const justificativaCellContent = `<p onclick="enableTextEdit(this.parentNode)" class="center-if-empty">-</p>`;

            let rowHTML = `
                <td class="row-number"></td>
                <td><input type="date"></td>
                <td><input type="number" value="X" oninput="validateAttendance(this)"></td>
                <td><input type="number" value="X" oninput="validateAttendance(this)"></td>
                <td><input type="number" value="X" oninput="validateAttendance(this)"></td>
                <td>${cardapioCellContent}</td>
                <td><button class="remove-row-btn" onclick="removeRow(this, 'table-cardapio-body')">&#128465;</button></td>
                <td>${justificativaCellContent}</td>
            `;

            newRow.innerHTML = rowHTML;
            newRow.querySelectorAll('input[type="number"]').forEach(input => formatAttendance(input));

            updateRowNumbers();
        }

        function updateTable3Row(element) {
            const row = element.closest('tr');
            if (!row) return;

            const quantInput = row.cells[0].querySelector('input[type="number"]');
            const descSelect = row.cells[1].querySelector('select');
            const consInput = row.cells[2].querySelector('input[type="number"]');
            const saldoAnteriorInput = row.cells[3].querySelector('input[type="number"]');
            
            const relatorioCell = row.cells[5];
            const relatorioP = relatorioCell.querySelector('p');
            const relatorioTextarea = relatorioCell.querySelector('textarea');
            
            const saldoAtualDisplay = row.cells[4];

            const selectedDescription = descSelect.options[descSelect.selectedIndex].text;
            const unit = UNITS[selectedDescription] || 'un';
            
            row.cells[0].querySelector('.unit').textContent = unit;
            row.cells[2].querySelector('.unit').textContent = unit;
            row.cells[3].querySelector('.unit').textContent = unit;
            
            const quant = parseFloat(quantInput.value.replace('-', '0')) || 0;
            const cons = parseFloat(consInput.value.replace('-', '0')) || 0;
            const saldoAnterior = parseFloat(saldoAnteriorInput.value.replace('-', '0')) || 0;

            if (!document.body.classList.contains('printing')) {
                quantInput.value = quant === 0 ? '-' : quant;
                consInput.value = cons === 0 ? '-' : cons;
                saldoAnteriorInput.value = saldoAnterior === 0 ? '-' : saldoAnterior;
                
                // Check and update the p tag content or textarea value
                if (relatorioP) {
                    const rawValue = relatorioP.textContent.trim();
                    if (rawValue === '' || rawValue === '0') {
                        relatorioP.textContent = '-';
                    }
                    // Apply centering
                    const finalValue = relatorioP.textContent.trim();
                    if (finalValue === '-' || finalValue === '0' || finalValue === '') {
                        relatorioP.classList.add('center-if-empty');
                    } else {
                        relatorioP.classList.remove('center-if-empty');
                    }
                } else if (relatorioTextarea) {
                    if (relatorioTextarea.value.trim() === '' || relatorioTextarea.value.trim() === '0') {
                        relatorioTextarea.value = '-';
                    }
                    autoGrowTextarea(relatorioTextarea);
                }
            }
            
            const saldoAtual = (quant + saldoAnterior) - cons;

            saldoAtualDisplay.textContent = saldoAtual.toFixed(0) + ' ' + unit;
        }

        function addRowTable3() {
            const tbody = document.getElementById('table-estoque-body');
            const newRow = tbody.insertRow();
            
            const generoOptions = Object.keys(UNITS).map(key => `<option value="${UNITS[key]}">${key}</option>`).join('');
            
            const relatorioCellContent = `<p onclick="enableTextEdit(this.parentNode)" class="center-if-empty">-</p>`;

            newRow.innerHTML = `
                <td><div class="quantity-cell"><input type="number" value="-" oninput="updateTable3Row(this)"> <span class="unit">un</span></div></td>
                <td><select onchange="updateTable3Row(this)">${generoOptions}</select></td>
                <td><div class="quantity-cell"><input type="number" value="-" oninput="updateTable3Row(this)"> <span class="unit">un</span></div></td>
                <td><div class="quantity-cell"><input type="number" value="-" oninput="updateTable3Row(this)"> <span class="unit">un</span></div></td>
                <td class="calculated-balance">0 un</td>
                <td>${relatorioCellContent}</td>
                <td><button class="remove-row-btn" onclick="removeRow(this, 'table-estoque-body')">&#128465;</button></td>
            `;

            updateTable3Row(newRow.cells[1].querySelector('select'));
        }
        
        function initializeTable3() {
            const tbody = document.getElementById('table-estoque-body');
            tbody.innerHTML = '';

            const defaultItems = Object.keys(UNITS).filter(key => 
                key !== 'OUTRO (a ser especificado)' && 
                !key.includes('Mingau de banana') && 
                !key.includes('Filé de peixe') && 
                !key.includes('Frango desfiado com arroz') && 
                !key.includes('Suco de fruta com pão') &&
                !key.includes('Suco de fruta com biscoito salgado')
            );


            defaultItems.forEach(item => {
                const newRow = tbody.insertRow();
                const unit = UNITS[item];
                
                const generoOptions = Object.keys(UNITS).map(key => 
                    `<option value="${UNITS[key]}" ${key === item ? 'selected' : ''}>${key}</option>`
                ).join('');
                
                const relatorioCellContent = `<p onclick="enableTextEdit(this.parentNode)">-</p>`;

                newRow.innerHTML = `
                    <td><div class="quantity-cell"><input type="number" value="-" oninput="updateTable3Row(this)"> <span class="unit">${unit}</span></div></td>
                    <td><select onchange="updateTable3Row(this)">${generoOptions}</select></td>
                    <td><div class="quantity-cell"><input type="number" value="-" oninput="updateTable3Row(this)"> <span class="unit">${unit}</span></div></td>
                    <td><div class="quantity-cell"><input type="number" value="-" oninput="updateTable3Row(this)"> <span class="unit">${unit}</span></div></td>
                    <td class="calculated-balance">0 ${unit}</td>
                    <td>${relatorioCellContent}</td>
                    <td><button class="remove-row-btn" onclick="removeRow(this, 'table-estoque-body')">&#128465;</button></td>
                `;
                updateTable3Row(newRow.cells[1].querySelector('select'));
            });
        }


        function removeRow(button, tbodyId) {
            const row = button.closest('tr');
            const tbody = document.getElementById(tbodyId);
            if (row && tbody) {
                tbody.removeChild(row);
            }
            if (tbodyId === 'table-cardapio-body') {
                updateRowNumbers();
            }
        }

        let originalValuesT2 = [];
        let originalValuesT3 = [];

        function applyPrintFormatting() {
            document.body.classList.add('printing');
            
            // Remove edit buttons for printing
            document.querySelectorAll('.remove-row-btn').forEach(btn => btn.style.display = 'none');

            // T2 Attendance Inputs
            const t2Inputs = document.querySelectorAll('#table-cardapio-body td:nth-child(3) input, #table-cardapio-body td:nth-child(4) input, #table-cardapio-body td:nth-child(5) input');
            originalValuesT2 = Array.from(t2Inputs).map(input => {
                const original = input.value;
                if (original === '' || original === '0' || original.toUpperCase() === 'X') {
                    input.value = 'X';
                }
                return { input, original };
            });

            // T3 Inputs (to handle '-' and '0')
            const t3Inputs = document.querySelectorAll('#table-estoque-body input');
            originalValuesT3 = Array.from(t3Inputs).map(input => {
                const original = input.value;
                if (input.type === 'number') {
                    const numericValue = parseFloat(original.replace('-', '0')) || 0;
                    if (numericValue === 0 || original === '') {
                        input.value = '-';
                    }
                }
                return { input, original };
            });
            
            // Ensure calculated balance is correct on print
            document.querySelectorAll('#table-estoque-body select').forEach(select => updateTable3Row(select));
        }

        function restoreOriginalFormatting() {
            document.body.classList.remove('printing');
            
            // Restore edit buttons
            document.querySelectorAll('.remove-row-btn').forEach(btn => btn.style.display = '');

            originalValuesT2.forEach(item => item.input.value = item.original);
            originalValuesT3.forEach(item => item.input.value = item.original);
            
            document.querySelectorAll('#table-estoque-body select').forEach(select => updateTable3Row(select));
        }

        // ====================================================================
        //              FUNÇÕES: EXPORTAÇÃO E IMPORTAÇÃO (TXT/PLANILHA)
        // ====================================================================

        function collectData() {
            const data = {};

            // 1. Coleta dos dados da Sidebar (Tabela 1 e Período)
            data.sidebar = {};
            document.querySelectorAll('.sidebar input:not([type="file"]), .sidebar select').forEach(input => {
                if (input.type === 'radio') {
                    if (input.checked) {
                        data.sidebar[input.name] = input.value;
                    }
                } else {
                    data.sidebar[input.id] = input.value;
                }
            });
            data.sidebar.tipo_cardapio = currentCardapioType; 
            
            // 2. Coleta dos dados da Tabela 2 (Cardápio)
            data.table2 = [];
            const t2rows = document.getElementById('table-cardapio-body').querySelectorAll('tr');
            t2rows.forEach(row => {
                const inputs = row.querySelectorAll('input'); // Only inputs for the first 5 columns
                const cardapioCell = row.cells[5];
                const justificativaCell = row.cells[7];
                
                // Get the current value from the p tag, or from the input if currently editing
                const cardapioValue = cardapioCell.querySelector('p') ? cardapioCell.querySelector('p').textContent : cardapioCell.querySelector('select').value;
                // Get the innerHTML and replace <br> with \n for saving
                const justificativaValue = justificativaCell.querySelector('p') ? justificativaCell.querySelector('p').innerHTML.replace(/<br>/g, '\n') : justificativaCell.querySelector('textarea').value;
                
                data.table2.push({
                    data: inputs[0].value,
                    freq_creche: inputs[1].value,
                    freq_ed_inf_fund: inputs[2].value,
                    freq_eja: inputs[3].value,
                    cardapio: cardapioValue,
                    justificativa: justificativaValue, 
                });
            });

            // 3. Coleta dos dados da Tabela 3 (Estoque)
            data.table3 = [];
            const t3rows = document.getElementById('table-estoque-body').querySelectorAll('tr');
            t3rows.forEach(row => {
                const descSelect = row.cells[1].querySelector('select');
                const descricaoText = descSelect.options[descSelect.selectedIndex].text;
                
                const relatorioCell = row.cells[5];
                // Get the innerHTML and replace <br> with \n for saving
                const relatorioValue = relatorioCell.querySelector('p') ? relatorioCell.querySelector('p').innerHTML.replace(/<br>/g, '\n') : relatorioCell.querySelector('textarea').value;


                data.table3.push({
                    recebido: row.cells[0].querySelector('input').value,
                    descricao: descricaoText, 
                    consumido: row.cells[2].querySelector('input').value,
                    saldo_anterior: row.cells[3].querySelector('input').value,
                    relatorio: relatorioValue, 
                });
            });

            return data;
        }

        function exportDataToTEXT() {
            const data = collectData();
            const textData = JSON.stringify(data, null, 2);
            const blob = new Blob([textData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            
            const date = new Date().toISOString().substring(0, 10);
            const schoolName = document.getElementById('nome_escola_input').value.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'demonstrativo';
            
            a.download = `demonstrativo_${schoolName}_${date}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert("Dados exportados! Salve o arquivo .txt. Você pode abri-lo em um editor de texto ou planilha (como Google Sheets ou Excel) para editar os dados. Lembre-se de manter o formato do arquivo para importar novamente.");
        }

        function importDataFromTEXT() {
            const fileInput = document.getElementById('import_file');
            const file = fileInput.files[0];

            if (!file) {
                alert("Por favor, selecione um arquivo de dados (.txt) para importar.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    applyImportedData(importedData);
                    alert("Dados importados com sucesso! Clique em 'Gerar Tabela' se notar alguma inconsistência no período.");
                } catch (e) {
                    alert("Erro ao processar o arquivo de dados. Certifique-se de que o arquivo (.txt) não foi corrompido ou alterado de forma incompatível com o sistema.");
                    console.error("Erro de importação:", e);
                }
            };
            reader.readAsText(file);
        }

        function applyImportedData(data) {
            // 1. Aplicar dados da Sidebar (Tabela 1 e Período)
            if (data.sidebar) {
                for (const id in data.sidebar) {
                    const element = document.getElementById(id);
                    if (element) {
                        if (id === 'tipo_cardapio') {
                            const radio = document.querySelector(`input[name="tipo_cardapio"][value="${data.sidebar[id]}"]`);
                            if (radio) {
                                radio.checked = true;
                                currentCardapioType = data.sidebar[id];
                            }
                        } else {
                            element.value = data.sidebar[id];
                        }
                    }
                }
            }

            // 2. Aplicar dados da Tabela 2 (Cardápio)
            if (data.table2) {
                const tbody = document.getElementById('table-cardapio-body');
                tbody.innerHTML = ''; 
                data.table2.forEach(rowData => {
                    const newRow = tbody.insertRow();
                    
                    // Formato para P Tag com click-to-edit
                    const justificativaPContent = rowData.justificativa.replace(/\n/g, '<br>');
                    
                    // Centralização na importação
                    const isCardapioCentered = rowData.cardapio.trim() === '-' || rowData.cardapio.trim() === '';
                    const isJustificativaCentered = rowData.justificativa.trim() === '-' || rowData.justificativa.trim() === '';
                    
                    const cardapioCellContent = `<p onclick="enableCardapioEdit(this.parentNode)" class="${isCardapioCentered ? 'center-if-empty' : ''}">${rowData.cardapio}</p>`;
                    const justificativaCellContent = `<p onclick="enableTextEdit(this.parentNode)" class="${isJustificativaCentered ? 'center-if-empty' : ''}">${justificativaPContent}</p>`;
                    
                    let rowHTML = `
                        <td class="row-number"></td>
                        <td><input type="date" value="${rowData.data}"></td>
                        <td><input type="number" value="${rowData.freq_creche}" oninput="validateAttendance(this)"></td>
                        <td><input type="number" value="${rowData.freq_ed_inf_fund}" oninput="validateAttendance(this)"></td>
                        <td><input type="number" value="${rowData.freq_eja}" oninput="validateAttendance(this)"></td>
                        <td>${cardapioCellContent}</td>
                        <td><button class="remove-row-btn" onclick="removeRow(this, 'table-cardapio-body')">&#128465;</button></td>
                        <td>${justificativaCellContent}</td>
                    `;
                    newRow.innerHTML = rowHTML;
                    
                    newRow.querySelectorAll('input[type="number"]').forEach(input => formatAttendance(input));
                });
                updateRowNumbers();
            }

            // 3. Aplicar dados da Tabela 3 (Estoque)
            if (data.table3) {
                const tbody = document.getElementById('table-estoque-body');
                tbody.innerHTML = '';
                data.table3.forEach(rowData => {
                    const newRow = tbody.insertRow();
                    const unit = UNITS[rowData.descricao] || 'un';
                    
                    const generoOptions = Object.keys(UNITS).map(key => 
                        `<option value="${UNITS[key]}" ${key === rowData.descricao ? 'selected' : ''}>${key}</option>`
                    ).join('');

                    // Formato para P Tag com click-to-edit
                    const relatorioPContent = rowData.relatorio.replace(/\n/g, '<br>');
                    const isRelatorioCentered = rowData.relatorio.trim() === '-' || rowData.relatorio.trim() === '';
                    const relatorioCellContent = `<p onclick="enableTextEdit(this.parentNode)" class="${isRelatorioCentered ? 'center-if-empty' : ''}">${relatorioPContent}</p>`;
                    
                    newRow.innerHTML = `
                        <td><div class="quantity-cell"><input type="number" value="${rowData.recebido}" oninput="updateTable3Row(this)"> <span class="unit">${unit}</span></div></td>
                        <td><select onchange="updateTable3Row(this)">${generoOptions}</select></td>
                        <td><div class="quantity-cell"><input type="number" value="${rowData.consumido}" oninput="updateTable3Row(this)"> <span class="unit">${unit}</span></div></td>
                        <td><div class="quantity-cell"><input type="number" value="${rowData.saldo_anterior}" oninput="updateTable3Row(this)"> <span class="unit">${unit}</span></div></td>
                        <td class="calculated-balance">0 ${unit}</td>
                        <td>${relatorioCellContent}</td>
                        <td><button class="remove-row-btn" onclick="removeRow(this, 'table-estoque-body')">&#128465;</button></td>
                    `;
                    updateTable3Row(newRow.cells[1].querySelector('select'));
                });
            }
            
            syncSidebarToTable1();
        }


        document.addEventListener('DOMContentLoaded', () => {
            const table1Inputs = document.querySelectorAll('.sidebar input:not([type="date"]), .sidebar select');
            table1Inputs.forEach(input => {
                if (input.id !== 'document_date_input') {
                    input.addEventListener('input', syncSidebarToTable1);
                    input.addEventListener('change', syncSidebarToTable1);
                }
            });
            
            document.getElementById('document_date_input').addEventListener('change', updateDocumentDate);
            
            const cardapioRadios = document.querySelectorAll('input[name="tipo_cardapio"]');
            cardapioRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    currentCardapioType = event.target.value;
                    generateTable2Rows(); 
                });
            });

            syncSidebarToTable1();
            generateTable2Rows();
            initializeTable3();

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('document_date_input').value = today;
            updateDocumentDate(); 
            
            if (window.matchMedia) {
                window.matchMedia('print').addListener(function(mql) {
                    if (mql.matches) {
                        applyPrintFormatting();
                    } else {
                        restoreOriginalFormatting();
                    }
                });
            }
            window.onbeforeprint = applyPrintFormatting;
            window.onafterprint = restoreOriginalFormatting;
        });
    </script>
    <!--1.1<script>
        const UNITS = {
            'Açúcar triturado': 'kg', 'Arroz tipo 1': 'kg', 'Biscoito salgado cream cracker': 'pcts',
            'Carne moída': 'kg', 'Leite em pó integral': 'pcts', 'Peito de frango': 'kg',
            'Feijão tipo 1': 'kg', 'Alho in natura': 'kg', 'Batata in natura': 'kg', 
            'Café em pó': 'pcts', 'Carne sem osso': 'kg', 'Cebola in natura': 'kg', 
            'Cenoura in natura': 'kg', 'Colorau': 'pcts', 'Coco ralado': 'pcts', 
            'Cominho moído': 'pcts', 'Farinha de trigo': 'kg', 'Macarrão espaguete': 'pcts', 
            'Óleo de soja 900ml': 'pets', 'Polpa de frutas': 'pcts', 'Milho Branco': 'pcts',
            'Azeite de dendê': 'grfs', 'Vinagre de álcool': 'grfs', 'Massa para sopa': 'pcts', 
            'Sal moído': 'kg', 'Mingau de banana grande': 'un', 'Filé de peixe desfiado com arroz': 'un',
            'Frango desfiado com arroz': 'un', 'Suco de fruta com pão e carne moída': 'un', 
            'Suco de fruta com biscoito salgado': 'un', 'OUTRO (a ser especificado)': 'un'
        };

        const CALENDARIO_LETIVO_2025 = {
            ano_inicio: '2025-02-10',
            ano_fim: '2025-12-23',
            nao_letivos: [
                '2025-03-04', '2025-03-05', 
                '2025-05-01',
                '2025-06-19',
                '2025-08-15',
                '2025-10-02', '2025-10-15', '2025-10-28',
                '2025-11-20',
            ].reduce((acc, date) => { acc[date] = true; return acc; }, {}),
            sabadosLetivos: [
                '2025-05-03', '2025-05-17',
                '2025-06-07', '2025-06-28',
                '2025-07-05', '2025-07-19',
                '2025-08-02', '2025-08-23',
                '2025-09-06', '2025-09-20',
                '2025-10-04', '2025-10-18',
                '2025-11-08', '2025-11-22',
                '2025-12-06', '2025-12-20',
            ].reduce((acc, date) => { acc[date] = true; return acc; }, {}),
            diasLetivosMarco: [
                '2025-03-03', '2025-03-06', '2025-03-07', '2025-03-10', '2025-03-11', 
                '2025-03-12', '2025-03-13', '2025-03-14'
            ].reduce((acc, date) => { acc[date] = true; return acc; }, {}),
        };
        
        const CARDAPIO_REGULAR = {
            1: {
                1: "Café com leite e biscoito salgado",
                2: "Frango desfiado com arroz branco",
                3: "Sopa de feijão com carne",
                4: "Mingau de milho branco",
                5: "Carne moída com macarrão",
            },
            2: {
                1: "Mingau de farinha de tapioca",
                2: "Carne moída com macarrão",
                3: "Feijão com carne, arroz branco e verduras",
                4: "Suco de fruta com biscoito salgado",
                5: "Batapá de frango",
            },
            3: {
                1: "Café com leite e biscoito salgado",
                2: "Frango desfiado e arroz branco",
                3: "Sopa de feijão com carne e verduras",
                4: "Mingau de milho branco",
                5: "Filé de peixe desfiado com arroz",
            },
            4: {
                1: "Mingau de farinha de tapioca",
                2: "Carne moída com macarrão",
                3: "Feijão de carne com arroz branco",
                4: "Suco de fruta com pão e carne moída",
                5: "Vatapá de frango",
            },
            sabado: "Café com leite, biscoito e salgado",
        };
        
        const CARDAPIO_INTEGRAL = {
            1: {
                1: "Café com leite, pão e queijo (Manhã) | Frango desfiado e Arroz com Salada (Almoço)",
                2: "Mingau de aveia (Manhã) | Feijão, Arroz, Carne Moída e Legumes (Almoço)",
                3: "Suco de fruta e Biscoito (Manhã) | Sopa reforçada com carne e macarrão (Almoço)",
                4: "Iogurte e fruta (Manhã) | Peito de frango assado, purê de batata e suco (Almoço)",
                5: "Café com leite e bolo (Manhã) | Carne de panela, macarrão e verduras (Almoço)",
            },
            2: {
                1: "Mingau de farinha de tapioca (Manhã) | Carne moída, Arroz e Salada (Almoço)",
                2: "Café com leite e biscoito salgado (Manhã) | Feijão com carne, arroz branco e verduras (Almoço)",
                3: "Pão com ovo e fruta (Manhã) | Vatapá de frango com arroz (Almoço)",
                4: "Suco de fruta com pão e carne moída (Manhã) | Peixe ensopado com legumes e farofa (Almoço)",
                5: "Mingau de milho branco (Manhã) | Strogonoff de frango e arroz (Almoço)",
            },
            3: this[1], 
            4: this[2], 
            sabado: "Almoço especial de sábado letivo: Feijoada leve com arroz.",
        };


        const ALL_CARDAPIOS_RAW = [
            ...Object.values(CARDAPIO_REGULAR[1]),
            ...Object.values(CARDAPIO_REGULAR[2]),
            ...Object.values(CARDAPIO_REGULAR[3]),
            ...Object.values(CARDAPIO_REGULAR[4]),
            CARDAPIO_REGULAR.sabado,
            ...Object.values(CARDAPIO_INTEGRAL[1]),
            ...Object.values(CARDAPIO_INTEGRAL[2]),
            CARDAPIO_INTEGRAL.sabado,
            "Mingau de banana grande", 
            "Frango desfiado com arroz", 
            "Suco de fruta com pão e carne moída", 
            "Suco de fruta com biscoito salgado", 
        ];
        const CARDAPIO_OPTIONS = [...new Set(ALL_CARDAPIOS_RAW)].sort();
        
        let currentCardapioType = 'regular'; 
        
        function syncSidebarToTable1() {
            document.getElementById('nome_escola_display').textContent = document.getElementById('nome_escola_input').value;
            document.getElementById('endereco_escola_display').textContent = document.getElementById('endereco_escola_input').value;
            document.getElementById('meio_escola_display').textContent = document.getElementById('meio_escola_input').value;
            document.getElementById('municipio_escola_display').textContent = document.getElementById('municipio_escola_input').value;
            document.getElementById('num_alunos_display').textContent = document.getElementById('num_alunos_input').value;
            document.getElementById('tipo_ensino_display').textContent = document.getElementById('tipo_ensino_input').value;

            const inicio = document.getElementById('periodo_inicio_input').value;
            const fim = document.getElementById('periodo_fim_input').value;
            const inicioDisplay = inicio ? formatDateToDisplay(inicio) : '';
            const fimDisplay = fim ? formatDateToDisplay(fim) : '';
            document.getElementById('periodo_display').innerHTML = `${inicioDisplay}<br>${fimDisplay}`;
        }

        function updateDocumentDate() {
            const dateInput = document.getElementById('document_date_input').value;
            if (dateInput) {
                const dateObj = new Date(dateInput + 'T00:00:00');
                const options = { day: 'numeric', month: 'long', year: 'numeric' };
                const formattedDate = dateObj.toLocaleDateString('pt-BR', options);
                document.getElementById('document_date_display').textContent = formattedDate;
            }
        }

        function formatDateToDisplay(dateString) {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }
        
        function getWeekOfMonth(date) {
            const d = new Date(date.getTime());
            d.setDate(1); 
            
            let firstMonday = new Date(date.getFullYear(), date.getMonth(), 1);
            while (firstMonday.getDay() !== 1) { 
                firstMonday.setDate(firstMonday.getDate() + 1);
            }
            
            let week = 1;
            let tempDate = new Date(firstMonday.getTime());
            
            while (tempDate <= date) {
                if (tempDate.getDay() === 1 && tempDate.toDateString() !== firstMonday.toDateString()) {
                    week++;
                }
                
                if (tempDate.toDateString() === date.toDateString()) {
                    return (week - 1) % 4 + 1;
                }
                
                tempDate.setDate(tempDate.getDate() + 1);
            }
            
            return 1;
        }

        function getCardapioForDate(date) {
            const dateISO = date.toISOString().substring(0, 10);
            const dayOfWeek = date.getDay();
            
            const CARDAPIOS_SELECIONADOS = currentCardapioType === 'integral' ? CARDAPIO_INTEGRAL : CARDAPIO_REGULAR;

            if (dayOfWeek === 6 && CALENDARIO_LETIVO_2025.sabadosLetivos[dateISO]) {
                return CARDAPIOS_SELECIONADOS.sabado;
            }

            if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                const weekOfMonth = getWeekOfMonth(date);
                const effectiveWeek = (weekOfMonth > 4) ? (weekOfMonth - 1) % 4 + 1 : weekOfMonth;
                const dayIndex = dayOfWeek;
                
                const weekCardapio = CARDAPIOS_SELECIONADOS[effectiveWeek];
                
                return weekCardapio ? weekCardapio[dayIndex] : "Cardápio Indefinido";
            }

            return null; 
        }

        function isLetivo(date) {
            const dateISO = date.toISOString().substring(0, 10);
            const dayOfWeek = date.getDay();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();

            const schoolStart = new Date(CALENDARIO_LETIVO_2025.ano_inicio + 'T00:00:00');
            const schoolEnd = new Date(CALENDARIO_LETIVO_2025.ano_fim + 'T00:00:00');
            if (date < schoolStart || date > schoolEnd) {
                return false;
            }

            if (CALENDARIO_LETIVO_2025.nao_letivos[dateISO]) {
                return false;
            }
            
            if (month === 4) {
                return false;
            }

            if (dayOfWeek === 0) {
                return false;
            }
            
            if (month === 3) {
                return CALENDARIO_LETIVO_2025.diasLetivosMarco[dateISO] || false;
            }

            if (dayOfWeek === 6) {
                return CALENDARIO_LETIVO_2025.sabadosLetivos[dateISO] || false;
            }
            
            return dayOfWeek >= 1 && dayOfWeek <= 5;
        }


        function validateAttendance(input) {
            const row = input.closest('tr');
            const maxAlunos = parseInt(document.getElementById('num_alunos_input').value) || 0;
            
            if (maxAlunos === 0) return;

            const inputs = Array.from(row.cells).slice(2, 5).map(cell => cell.querySelector('input[type="number"]'));
            let currentSum = 0;
            
            inputs.forEach(inp => {
                const val = inp.value;
                if (val.toUpperCase() !== 'X' && !isNaN(parseInt(val))) {
                    currentSum += parseInt(val);
                }
            });

            if (currentSum > maxAlunos) {
                alert(`A soma de alunos (${currentSum}) excede o total matriculado (${maxAlunos}).`);
                input.value = 'X'; 
            }
            
            formatAttendance(input);
        }
        
        function formatAttendance(input) {
            if (input.value === '' || input.value === '0' || input.value.toUpperCase() === 'X') {
                input.value = 'X';
            }
        }
        
        function handleCardapioChange(selectElement) {
            const row = selectElement.closest('tr');
            const dateInput = row.cells[1].querySelector('input[type="date"]');
            const justificativaInput = row.cells[7].querySelector('input[type="text"]');
            
            const dateISO = dateInput.value;
            const selectedCardapio = selectElement.value;
            
            const dateObj = new Date(dateISO + 'T00:00:00');
            const cardapioPrevisto = getCardapioForDate(dateObj);
            
            const dateDisplay = formatDateToDisplay(dateISO);
            const isSabadoLetivo = dateObj.getDay() === 6 && CALENDARIO_LETIVO_2025.sabadosLetivos[dateISO];
            const sabadoJust = `(No dia ${dateDisplay}, sábado letivo, foi servida merenda)`;

            if (cardapioPrevisto && selectedCardapio !== cardapioPrevisto) {
                
                const novaJustificativa = `(No dia ${dateDisplay} o cardápio previsto era "${cardapioPrevisto}", mas foi substituido por "${selectedCardapio}")`;
                
                if (!justificativaInput.value || justificativaInput.value === sabadoJust || justificativaInput.value === '-') {
                    alert(`Atenção: O cardápio original de ${dateDisplay} era "${cardapioPrevisto}" e foi alterado para "${selectedCardapio}". Por favor, justifique no campo ao lado.`);
                    justificativaInput.value = novaJustificativa;
                }

            } else if (cardapioPrevisto && selectedCardapio === cardapioPrevisto) {
                if (justificativaInput.value.includes('o cardápio previsto era')) {
                    justificativaInput.value = isSabadoLetivo ? sabadoJust : '-';
                } else if (isSabadoLetivo) {
                    justificativaInput.value = sabadoJust;
                } else {
                    justificativaInput.value = '-';
                }
            }
        }

        function updateRowNumbers() {
            const rows = document.getElementById('table-cardapio-body').querySelectorAll('tr');
            rows.forEach((row, index) => {
                const numCell = row.querySelector('.row-number');
                if (numCell) {
                    numCell.textContent = index + 1;
                }
            });
        }

        function setupTable2RowListeners(newRow) {
            const freqInputs = newRow.querySelectorAll('input[type="number"]');
            freqInputs.forEach(input => {
                input.addEventListener('input', () => validateAttendance(input));
                formatAttendance(input); 
            });

            const selectCardapio = newRow.querySelector('select');
            if (selectCardapio) {
                selectCardapio.addEventListener('change', () => handleCardapioChange(selectCardapio));
            }
        }

        function generateTable2Rows() {
            const tbody = document.getElementById('table-cardapio-body');
            const inicioInput = document.getElementById('periodo_inicio_input').value;
            const fimInput = document.getElementById('periodo_fim_input').value;

            syncSidebarToTable1();
            
            if (!inicioInput || !fimInput) {
                alert("Por favor, defina as datas de início e fim do período.");
                return;
            }

            const startDate = new Date(inicioInput + 'T00:00:00');
            const endDate = new Date(fimInput + 'T00:00:00');

            if (startDate > endDate) {
                alert("A data de início deve ser anterior ou igual à data de fim.");
                return;
            }
            
            tbody.innerHTML = '';
            let currentDate = startDate;

            while (currentDate <= endDate) {
                const dateISO = currentDate.toISOString().substring(0, 10);
                
                if (isLetivo(currentDate)) {
                    const newRow = tbody.insertRow();
                    const dateDisplay = formatDateToDisplay(dateISO);
                    
                    const cardapioPrevisto = getCardapioForDate(currentDate);
                    const isSabadoLetivo = currentDate.getDay() === 6;
                    
                    let justificativaInicial = '-';
                    if (isSabadoLetivo) {
                        justificativaInicial = `(No dia ${dateDisplay}, sábado letivo, foi servida merenda)`;
                    }
                    
                    const optionsHTML = CARDAPIO_OPTIONS.map(opt => 
                        `<option value="${opt}" ${opt === cardapioPrevisto ? 'selected' : ''}>${opt}</option>`
                    ).join('');

                    let rowHTML = `
                        <td class="row-number"></td>
                        <td><input type="date" value="${dateISO}"></td>
                        <td><input type="number" value="X"></td>
                        <td><input type="number" value="X"></td>
                        <td><input type="number" value="X"></td>
                        <td><select>${optionsHTML}</select></td>
                        <td><button class="remove-row-btn" onclick="removeRow(this, 'table-cardapio-body')">&#128465;</button></td>
                        <td><input type="text" value="${justificativaInicial}" style="width: 98%; text-align: left;"></td>
                    `;

                    newRow.innerHTML = rowHTML;
                    setupTable2RowListeners(newRow); 
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            updateRowNumbers();
        }
        
        function addRowTable2() {
            const tbody = document.getElementById('table-cardapio-body');
            const newRow = tbody.insertRow();
            const optionsHTML = CARDAPIO_OPTIONS.map(opt => `<option value="${opt}">${opt}</option>`).join('');

            let rowHTML = `
                <td class="row-number"></td>
                <td><input type="date"></td>
                <td><input type="number" value="X"></td>
                <td><input type="number" value="X"></td>
                <td><input type="number" value="X"></td>
                <td><select>${optionsHTML}</select></td>
                <td><button class="remove-row-btn" onclick="removeRow(this, 'table-cardapio-body')">&#128465;</button></td>
                <td><input type="text" value="-"></td>
            `;

            newRow.innerHTML = rowHTML;
            setupTable2RowListeners(newRow);
            updateRowNumbers();
        }

        function updateTable3Row(element) {
            const row = element.closest('tr');
            if (!row) return;

            const quantInput = row.cells[0].querySelector('input[type="number"]');
            const descSelect = row.cells[1].querySelector('select');
            const consInput = row.cells[2].querySelector('input[type="number"]');
            const saldoAnteriorInput = row.cells[3].querySelector('input[type="number"]');
            const relatorioInput = row.cells[5].querySelector('input[type="text"]');

            const saldoAtualDisplay = row.cells[4];

            const selectedDescription = descSelect.options[descSelect.selectedIndex].text;
            const unit = UNITS[selectedDescription] || 'un';
            
            row.cells[0].querySelector('.unit').textContent = unit;
            row.cells[2].querySelector('.unit').textContent = unit;
            row.cells[3].querySelector('.unit').textContent = unit;
            
            const quant = parseFloat(quantInput.value.replace('-', '0')) || 0;
            const cons = parseFloat(consInput.value.replace('-', '0')) || 0;
            const saldoAnterior = parseFloat(saldoAnteriorInput.value.replace('-', '0')) || 0;

            if (!document.body.classList.contains('printing')) {
                quantInput.value = quant === 0 ? '-' : quant;
                consInput.value = cons === 0 ? '-' : cons;
                saldoAnteriorInput.value = saldoAnterior === 0 ? '-' : saldoAnterior;
                
                if (relatorioInput.value === '' || relatorioInput.value === '0') {
                    relatorioInput.value = '-';
                }
            }
            
            const saldoAtual = (quant + saldoAnterior) - cons;

            saldoAtualDisplay.textContent = saldoAtual.toFixed(0) + ' ' + unit;
        }

        function addRowTable3() {
            const tbody = document.getElementById('table-estoque-body');
            const newRow = tbody.insertRow();
            
            const generoOptions = Object.keys(UNITS).map(key => `<option value="${UNITS[key]}">${key}</option>`).join('');

            newRow.innerHTML = `
                <td><div class="quantity-cell"><input type="number" value="-" oninput="updateTable3Row(this)"> <span class="unit">un</span></div></td>
                <td><select onchange="updateTable3Row(this)">${generoOptions}</select></td>
                <td><div class="quantity-cell"><input type="number" value="-" oninput="updateTable3Row(this)"> <span class="unit">un</span></div></td>
                <td><div class="quantity-cell"><input type="number" value="-" oninput="updateTable3Row(this)"> <span class="unit">un</span></div></td>
                <td class="calculated-balance">0 un</td>
                <td><input type="text" value="-" style="width: 95%; text-align: left;" oninput="updateTable3Row(this)"></td>
                <td><button class="remove-row-btn" onclick="removeRow(this, 'table-estoque-body')">&#128465;</button></td>
            `;

            updateTable3Row(newRow.cells[1].querySelector('select'));
        }
        
        function initializeTable3() {
            const tbody = document.getElementById('table-estoque-body');
            tbody.innerHTML = '';

            const defaultItems = Object.keys(UNITS).filter(key => 
                key !== 'OUTRO (a ser especificado)' && 
                !key.includes('Mingau de banana') && 
                !key.includes('Filé de peixe') && 
                !key.includes('Frango desfiado com arroz') && 
                !key.includes('Suco de fruta com pão') &&
                !key.includes('Suco de fruta com biscoito salgado')
            );


            defaultItems.forEach(item => {
                const newRow = tbody.insertRow();
                const unit = UNITS[item];
                
                const generoOptions = Object.keys(UNITS).map(key => 
                    `<option value="${UNITS[key]}" ${key === item ? 'selected' : ''}>${key}</option>`
                ).join('');

                newRow.innerHTML = `
                    <td><div class="quantity-cell"><input type="number" value="-" oninput="updateTable3Row(this)"> <span class="unit">${unit}</span></div></td>
                    <td><select onchange="updateTable3Row(this)">${generoOptions}</select></td>
                    <td><div class="quantity-cell"><input type="number" value="-" oninput="updateTable3Row(this)"> <span class="unit">${unit}</span></div></td>
                    <td><div class="quantity-cell"><input type="number" value="-" oninput="updateTable3Row(this)"> <span class="unit">${unit}</span></div></td>
                    <td class="calculated-balance">0 ${unit}</td>
                    <td><input type="text" value="-" style="width: 95%; text-align: left;" oninput="updateTable3Row(this)"></td>
                    <td><button class="remove-row-btn" onclick="removeRow(this, 'table-estoque-body')">&#128465;</button></td>
                `;
                updateTable3Row(newRow.cells[1].querySelector('select'));
            });
        }


        function removeRow(button, tbodyId) {
            const row = button.closest('tr');
            const tbody = document.getElementById(tbodyId);
            if (row && tbody) {
                tbody.removeChild(row);
            }
            if (tbodyId === 'table-cardapio-body') {
                updateRowNumbers();
            }
        }

        let originalValuesT2 = [];
        let originalValuesT3 = [];

        function applyPrintFormatting() {
            document.body.classList.add('printing');
            
            const t2Inputs = document.querySelectorAll('#table-cardapio-body td:nth-child(3) input, #table-cardapio-body td:nth-child(4) input, #table-cardapio-body td:nth-child(5) input');
            originalValuesT2 = Array.from(t2Inputs).map(input => {
                const original = input.value;
                if (original === '' || original === '0' || original.toUpperCase() === 'X') {
                    input.value = 'X';
                }
                return { input, original };
            });

            const t3Inputs = document.querySelectorAll('#table-estoque-body input');
            originalValuesT3 = Array.from(t3Inputs).map(input => {
                const original = input.value;
                if (input.type === 'number') {
                    const numericValue = parseFloat(original.replace('-', '0')) || 0;
                    if (numericValue === 0 || original === '') {
                        input.value = '-';
                    }
                } else if (input.type === 'text') {
                    if (original === '' || original === '0') {
                        input.value = '-';
                    }
                }
                return { input, original };
            });
            
            document.querySelectorAll('#table-estoque-body select').forEach(select => updateTable3Row(select));
        }

        function restoreOriginalFormatting() {
            document.body.classList.remove('printing');
            
            originalValuesT2.forEach(item => item.input.value = item.original);
            originalValuesT3.forEach(item => item.input.value = item.original);
            
            document.querySelectorAll('#table-estoque-body select').forEach(select => updateTable3Row(select));
        }

        // ====================================================================
        //              FUNÇÕES: EXPORTAÇÃO E IMPORTAÇÃO (TXT/PLANILHA)
        // ====================================================================

        function collectData() {
            const data = {};

            // 1. Coleta dos dados da Sidebar (Tabela 1 e Período)
            data.sidebar = {};
            document.querySelectorAll('.sidebar input:not([type="file"]), .sidebar select').forEach(input => {
                if (input.type === 'radio') {
                    if (input.checked) {
                        data.sidebar[input.name] = input.value;
                    }
                } else {
                    data.sidebar[input.id] = input.value;
                }
            });
            data.sidebar.tipo_cardapio = currentCardapioType; 
            
            // 2. Coleta dos dados da Tabela 2 (Cardápio)
            data.table2 = [];
            const t2rows = document.getElementById('table-cardapio-body').querySelectorAll('tr');
            t2rows.forEach(row => {
                const inputs = row.querySelectorAll('input, select');
                data.table2.push({
                    data: inputs[0].value,
                    freq_creche: inputs[1].value,
                    freq_ed_inf_fund: inputs[2].value,
                    freq_eja: inputs[3].value,
                    cardapio: inputs[4].value,
                    justificativa: inputs[5].value,
                });
            });

            // 3. Coleta dos dados da Tabela 3 (Estoque)
            data.table3 = [];
            const t3rows = document.getElementById('table-estoque-body').querySelectorAll('tr');
            t3rows.forEach(row => {
                const inputs = row.querySelectorAll('input:not([type="text"]), select, input[type="text"]');
                data.table3.push({
                    recebido: inputs[0].value,
                    descricao: inputs[1].value,
                    consumido: inputs[2].value,
                    saldo_anterior: inputs[3].value,
                    relatorio: inputs[4].value,
                });
            });

            return data;
        }

        function exportDataToTEXT() {
            const data = collectData();
            const textData = JSON.stringify(data, null, 2);
            const blob = new Blob([textData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            
            const date = new Date().toISOString().substring(0, 10);
            const schoolName = document.getElementById('nome_escola_input').value.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'demonstrativo';
            
            // Exporta como .txt, que pode ser aberto por Excel
            a.download = `demonstrativo_${schoolName}_${date}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert("Dados exportados! Salve o arquivo .txt. Você pode abri-lo em um editor de texto ou planilha (como Google Sheets ou Excel) para editar os dados. Lembre-se de manter o formato do arquivo para importar novamente.");
        }

        function importDataFromTEXT() {
            const fileInput = document.getElementById('import_file');
            const file = fileInput.files[0];

            if (!file) {
                alert("Por favor, selecione um arquivo de dados (.txt) para importar.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    // Tenta fazer o parse do texto como JSON
                    const importedData = JSON.parse(event.target.result);
                    applyImportedData(importedData);
                    alert("Dados importados com sucesso! Clique em 'Gerar Tabela' se notar alguma inconsistência no período.");
                } catch (e) {
                    alert("Erro ao processar o arquivo de dados. Certifique-se de que o arquivo (.txt) não foi corrompido ou alterado de forma incompatível com o sistema.");
                    console.error("Erro de importação:", e);
                }
            };
            // Lê o arquivo como texto
            reader.readAsText(file);
        }

        function applyImportedData(data) {
            // 1. Aplicar dados da Sidebar (Tabela 1 e Período)
            if (data.sidebar) {
                for (const id in data.sidebar) {
                    const element = document.getElementById(id);
                    if (element) {
                        if (id === 'tipo_cardapio') {
                            // Trata o rádio
                            const radio = document.querySelector(`input[name="tipo_cardapio"][value="${data.sidebar[id]}"]`);
                            if (radio) {
                                radio.checked = true;
                                currentCardapioType = data.sidebar[id];
                            }
                        } else {
                            element.value = data.sidebar[id];
                        }
                    }
                }
            }

            // 2. Aplicar dados da Tabela 2 (Cardápio)
            if (data.table2) {
                const tbody = document.getElementById('table-cardapio-body');
                tbody.innerHTML = ''; 
                data.table2.forEach(rowData => {
                    const newRow = tbody.insertRow();
                    const optionsHTML = CARDAPIO_OPTIONS.map(opt => 
                        `<option value="${opt}" ${opt === rowData.cardapio ? 'selected' : ''}>${opt}</option>`
                    ).join('');

                    let rowHTML = `
                        <td class="row-number"></td>
                        <td><input type="date" value="${rowData.data}"></td>
                        <td><input type="number" value="${rowData.freq_creche}"></td>
                        <td><input type="number" value="${rowData.freq_ed_inf_fund}"></td>
                        <td><input type="number" value="${rowData.freq_eja}"></td>
                        <td><select>${optionsHTML}</select></td>
                        <td><button class="remove-row-btn" onclick="removeRow(this, 'table-cardapio-body')">&#128465;</button></td>
                        <td><input type="text" value="${rowData.justificativa}" style="width: 98%; text-align: left;"></td>
                    `;
                    newRow.innerHTML = rowHTML;
                    setupTable2RowListeners(newRow);
                });
                updateRowNumbers();
            }

            // 3. Aplicar dados da Tabela 3 (Estoque)
            if (data.table3) {
                const tbody = document.getElementById('table-estoque-body');
                tbody.innerHTML = '';
                data.table3.forEach(rowData => {
                    const newRow = tbody.insertRow();
                    const unit = UNITS[rowData.descricao] || 'un';
                    
                    const generoOptions = Object.keys(UNITS).map(key => 
                        `<option value="${UNITS[key]}" ${key === rowData.descricao ? 'selected' : ''}>${key}</option>`
                    ).join('');

                    newRow.innerHTML = `
                        <td><div class="quantity-cell"><input type="number" value="${rowData.recebido}" oninput="updateTable3Row(this)"> <span class="unit">${unit}</span></div></td>
                        <td><select onchange="updateTable3Row(this)">${generoOptions}</select></td>
                        <td><div class="quantity-cell"><input type="number" value="${rowData.consumido}" oninput="updateTable3Row(this)"> <span class="unit">${unit}</span></div></td>
                        <td><div class="quantity-cell"><input type="number" value="${rowData.saldo_anterior}" oninput="updateTable3Row(this)"> <span class="unit">${unit}</span></div></td>
                        <td class="calculated-balance">0 ${unit}</td>
                        <td><input type="text" value="${rowData.relatorio}" style="width: 95%; text-align: left;" oninput="updateTable3Row(this)"></td>
                        <td><button class="remove-row-btn" onclick="removeRow(this, 'table-estoque-body')">&#128465;</button></td>
                    `;
                    updateTable3Row(newRow.cells[1].querySelector('select'));
                });
            }
            
            syncSidebarToTable1();
        }


        document.addEventListener('DOMContentLoaded', () => {
            const table1Inputs = document.querySelectorAll('.sidebar input:not([type="date"]), .sidebar select');
            table1Inputs.forEach(input => {
                if (input.id !== 'document_date_input') {
                    input.addEventListener('input', syncSidebarToTable1);
                    input.addEventListener('change', syncSidebarToTable1);
                }
            });
            
            document.getElementById('document_date_input').addEventListener('change', updateDocumentDate);
            
            const cardapioRadios = document.querySelectorAll('input[name="tipo_cardapio"]');
            cardapioRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    currentCardapioType = event.target.value;
                    generateTable2Rows(); 
                });
            });

            syncSidebarToTable1();
            generateTable2Rows();
            initializeTable3();

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('document_date_input').value = today;
            updateDocumentDate(); 
            
            if (window.matchMedia) {
                window.matchMedia('print').addListener(function(mql) {
                    if (mql.matches) {
                        applyPrintFormatting();
                    } else {
                        restoreOriginalFormatting();
                    }
                });
            }
            window.onbeforeprint = applyPrintFormatting;
            window.onafterprint = restoreOriginalFormatting;
        });
    </script>-->
    <!--1.0<script>
        // ====================================================================
        //                         CONSTANTES IMPORTANTES
        // ====================================================================

        // --- 1. ITENS DA TABELA 3 E SUAS UNIDADES
        const UNITS = {
            'Açúcar triturado': 'kg', 'Arroz tipo 1': 'kg', 'Biscoito salgado cream cracker': 'pcts',
            'Carne moída': 'kg', 'Leite em pó integral': 'pcts', 'Peito de frango': 'kg',
            'Feijão tipo 1': 'kg', 'Alho in natura': 'kg', 'Batata in natura': 'kg', 
            'Café em pó': 'pcts', 'Carne sem osso': 'kg', 'Cebola in natura': 'kg', 
            'Cenoura in natura': 'kg', 'Colorau': 'pcts', 'Coco ralado': 'pcts', 
            'Cominho moído': 'pcts', 'Farinha de trigo': 'kg', 'Macarrão espaguete': 'pcts', 
            'Óleo de soja 900ml': 'pets', 'Polpa de frutas': 'pcts', 'Milho Branco': 'pcts',
            'Azeite de dendê': 'grfs', 'Vinagre de álcool': 'grfs', 'Massa para sopa': 'pcts', 
            'Sal moído': 'kg', 'Mingau de banana grande': 'un', 'Filé de peixe desfiado com arroz': 'un',
            'Frango desfiado com arroz': 'un', 'Suco de fruta com pão e carne moída': 'un', 
            'Suco de fruta com biscoito salgado': 'un', 'OUTRO (a ser especificado)': 'un'
        };

        // --- 2. CALENDÁRIO LETIVO DE 2025 (FORNECIDO PELO USUÁRIO)
        const CALENDARIO_LETIVO_2025 = {
            ano_inicio: '2025-02-10',
            ano_fim: '2025-12-23',
            nao_letivos: [
                '2025-03-04', '2025-03-05', 
                '2025-05-01',
                '2025-06-19',
                '2025-08-15',
                '2025-10-02', '2025-10-15', '2025-10-28',
                '2025-11-20',
            ].reduce((acc, date) => { acc[date] = true; return acc; }, {}),
            sabadosLetivos: [
                '2025-05-03', '2025-05-17',
                '2025-06-07', '2025-06-28',
                '2025-07-05', '2025-07-19',
                '2025-08-02', '2025-08-23',
                '2025-09-06', '2025-09-20',
                '2025-10-04', '2025-10-18',
                '2025-11-08', '2025-11-22',
                '2025-12-06', '2025-12-20',
            ].reduce((acc, date) => { acc[date] = true; return acc; }, {}),
            diasLetivosMarco: [
                '2025-03-03', '2025-03-06', '2025-03-07', '2025-03-10', '2025-03-11', 
                '2025-03-12', '2025-03-13', '2025-03-14'
            ].reduce((acc, date) => { acc[date] = true; return acc; }, {}),
        };
        
        // --- 3. CARDÁPIO SEMANAL PADRÃO (Índice 1=Mon, 5=Fri)
        
        // NOVO: Estrutura para Cardápio de Ensino Regular
        const CARDAPIO_REGULAR = {
            // Week 1
            1: {
                1: "Café com leite e biscoito salgado",
                2: "Frango desfiado com arroz branco",
                3: "Sopa de feijão com carne",
                4: "Mingau de milho branco",
                5: "Carne moída com macarrão",
            },
            // Week 2
            2: {
                1: "Mingau de farinha de tapioca",
                2: "Carne moída com macarrão",
                3: "Feijão com carne, arroz branco e verduras",
                4: "Suco de fruta com biscoito salgado",
                5: "Batapá de frango",
            },
            // Week 3
            3: {
                1: "Café com leite e biscoito salgado",
                2: "Frango desfiado e arroz branco",
                3: "Sopa de feijão com carne e verduras",
                4: "Mingau de milho branco",
                5: "Filé de peixe desfiado com arroz",
            },
            // Week 4 (e posteriores, pois o ciclo repete)
            4: {
                1: "Mingau de farinha de tapioca",
                2: "Carne moída com macarrão",
                3: "Feijão de carne com arroz branco",
                4: "Suco de fruta com pão e carne moída",
                5: "Vatapá de frango",
            },
            sabado: "Café com leite, biscoito e salgado",
        };
        
        // NOVO: Estrutura para Cardápio de Ensino Integral
        const CARDAPIO_INTEGRAL = {
            // O cardápio integral tem mais refeições ou opções diferentes.
            // EXEMPLO SIMPLES: Os itens do dia são mais completos ou têm uma segunda refeição.
            1: {
                1: "Café com leite, pão e queijo (Manhã) | Frango desfiado e Arroz com Salada (Almoço)",
                2: "Mingau de aveia (Manhã) | Feijão, Arroz, Carne Moída e Legumes (Almoço)",
                3: "Suco de fruta e Biscoito (Manhã) | Sopa reforçada com carne e macarrão (Almoço)",
                4: "Iogurte e fruta (Manhã) | Peito de frango assado, purê de batata e suco (Almoço)",
                5: "Café com leite e bolo (Manhã) | Carne de panela, macarrão e verduras (Almoço)",
            },
            2: {
                1: "Mingau de farinha de tapioca (Manhã) | Carne moída, Arroz e Salada (Almoço)",
                2: "Café com leite e biscoito salgado (Manhã) | Feijão com carne, arroz branco e verduras (Almoço)",
                3: "Pão com ovo e fruta (Manhã) | Vatapá de frango com arroz (Almoço)",
                4: "Suco de fruta com pão e carne moída (Manhã) | Peixe ensopado com legumes e farofa (Almoço)",
                5: "Mingau de milho branco (Manhã) | Strogonoff de frango e arroz (Almoço)",
            },
            // Repetir o ciclo a cada 2 semanas para simplificar
            3: this[1], 
            4: this[2], 
            sabado: "Almoço especial de sábado letivo: Feijoada leve com arroz.",
        };


        // Lista de todos os cardápios possíveis para o <select>
        const ALL_CARDAPIOS_RAW = [
            ...Object.values(CARDAPIO_REGULAR[1]),
            ...Object.values(CARDAPIO_REGULAR[2]),
            ...Object.values(CARDAPIO_REGULAR[3]),
            ...Object.values(CARDAPIO_REGULAR[4]),
            CARDAPIO_REGULAR.sabado,
            ...Object.values(CARDAPIO_INTEGRAL[1]),
            ...Object.values(CARDAPIO_INTEGRAL[2]),
            CARDAPIO_INTEGRAL.sabado,
            "Mingau de banana grande", 
            "Frango desfiado com arroz", 
            "Suco de fruta com biscoito salgado", 
        ];
        const CARDAPIO_OPTIONS = [...new Set(ALL_CARDAPIOS_RAW)].sort();
        
        // Variável global para armazenar a escolha do cardápio (Default é Regular)
        let currentCardapioType = 'regular'; 
        
        // ====================================================================
        //                         FUNÇÕES DE CALENDÁRIO E CARDÁPIO
        // ====================================================================

        function syncSidebarToTable1() {
            document.getElementById('nome_escola_display').textContent = document.getElementById('nome_escola_input').value;
            document.getElementById('endereco_escola_display').textContent = document.getElementById('endereco_escola_input').value;
            document.getElementById('meio_escola_display').textContent = document.getElementById('meio_escola_input').value;
            document.getElementById('municipio_escola_display').textContent = document.getElementById('municipio_escola_input').value;
            document.getElementById('num_alunos_display').textContent = document.getElementById('num_alunos_input').value;
            document.getElementById('tipo_ensino_display').textContent = document.getElementById('tipo_ensino_input').value;

            const inicio = document.getElementById('periodo_inicio_input').value;
            const fim = document.getElementById('periodo_fim_input').value;
            const inicioDisplay = inicio ? formatDateToDisplay(inicio) : '';
            const fimDisplay = fim ? formatDateToDisplay(fim) : '';
            document.getElementById('periodo_display').innerHTML = `${inicioDisplay}<br>${fimDisplay}`;
        }

        function updateDocumentDate() {
            const dateInput = document.getElementById('document_date_input').value;
            if (dateInput) {
                const dateObj = new Date(dateInput + 'T00:00:00');
                const options = { day: 'numeric', month: 'long', year: 'numeric' };
                const formattedDate = dateObj.toLocaleDateString('pt-BR', options);
                document.getElementById('document_date_display').textContent = formattedDate;
            }
        }

        function formatDateToDisplay(dateString) {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }
        
        function getWeekOfMonth(date) {
            const d = new Date(date.getTime());
            d.setDate(1); 
            
            let firstMonday = new Date(date.getFullYear(), date.getMonth(), 1);
            while (firstMonday.getDay() !== 1) { 
                firstMonday.setDate(firstMonday.getDate() + 1);
            }
            
            let week = 1;
            let tempDate = new Date(firstMonday.getTime());
            
            while (tempDate <= date) {
                if (tempDate.getDay() === 1 && tempDate.toDateString() !== firstMonday.toDateString()) {
                    week++;
                }
                
                if (tempDate.toDateString() === date.toDateString()) {
                    return (week - 1) % 4 + 1;
                }
                
                tempDate.setDate(tempDate.getDate() + 1);
            }
            
            return 1;
        }

        function getCardapioForDate(date) {
            const dateISO = date.toISOString().substring(0, 10);
            const dayOfWeek = date.getDay();
            
            // NOVO: Seleciona a lista de cardápios com base na escolha do rádio
            const CARDAPIOS_SELECIONADOS = currentCardapioType === 'integral' ? CARDAPIO_INTEGRAL : CARDAPIO_REGULAR;

            if (dayOfWeek === 6 && CALENDARIO_LETIVO_2025.sabadosLetivos[dateISO]) {
                return CARDAPIOS_SELECIONADOS.sabado;
            }

            if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                const weekOfMonth = getWeekOfMonth(date);
                const effectiveWeek = (weekOfMonth > 4) ? (weekOfMonth - 1) % 4 + 1 : weekOfMonth;
                const dayIndex = dayOfWeek;
                
                const weekCardapio = CARDAPIOS_SELECIONADOS[effectiveWeek];
                
                return weekCardapio ? weekCardapio[dayIndex] : "Cardápio Indefinido";
            }

            return null; 
        }

        function isLetivo(date) {
            const dateISO = date.toISOString().substring(0, 10);
            const dayOfWeek = date.getDay();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();

            const schoolStart = new Date(CALENDARIO_LETIVO_2025.ano_inicio + 'T00:00:00');
            const schoolEnd = new Date(CALENDARIO_LETIVO_2025.ano_fim + 'T00:00:00');
            if (date < schoolStart || date > schoolEnd) {
                return false;
            }

            if (CALENDARIO_LETIVO_2025.nao_letivos[dateISO]) {
                return false;
            }
            
            if (month === 4) {
                return false;
            }

            if (dayOfWeek === 0) {
                return false;
            }
            
            if (month === 3) {
                return CALENDARIO_LETIVO_2025.diasLetivosMarco[dateISO] || false;
            }

            if (dayOfWeek === 6) {
                return CALENDARIO_LETIVO_2025.sabadosLetivos[dateISO] || false;
            }
            
            return dayOfWeek >= 1 && dayOfWeek <= 5;
        }


        // ====================================================================
        //                        FUNÇÕES DE TABELA
        // ====================================================================

        // Validação da soma de alunos (Tabela 2)
        function validateAttendance(input) {
            const row = input.closest('tr');
            const maxAlunos = parseInt(document.getElementById('num_alunos_input').value) || 0;
            
            if (maxAlunos === 0) return;

            const inputs = Array.from(row.cells).slice(2, 5).map(cell => cell.querySelector('input[type="number"]'));
            let currentSum = 0;
            
            inputs.forEach(inp => {
                const val = inp.value;
                if (val.toUpperCase() !== 'X' && !isNaN(parseInt(val))) {
                    currentSum += parseInt(val);
                }
            });

            if (currentSum > maxAlunos) {
                alert(`A soma de alunos (${currentSum}) excede o total matriculado (${maxAlunos}).`);
                input.value = 'X'; 
            }
            
            formatAttendance(input);
        }
        
        // Formata campos de frequência: 'X' se 0 ou vazio (Tabela 2)
        function formatAttendance(input) {
            if (input.value === '' || input.value === '0' || input.value.toUpperCase() === 'X') {
                input.value = 'X';
            }
        }
        
        // Lógica para controle de cardápio e justificativa (Tabela 2)
        function handleCardapioChange(selectElement) {
            const row = selectElement.closest('tr');
            const dateInput = row.cells[1].querySelector('input[type="date"]');
            const justificativaInput = row.cells[7].querySelector('input[type="text"]');
            
            const dateISO = dateInput.value;
            const selectedCardapio = selectElement.value;
            
            const dateObj = new Date(dateISO + 'T00:00:00');
            const cardapioPrevisto = getCardapioForDate(dateObj);
            
            const dateDisplay = formatDateToDisplay(dateISO);
            const isSabadoLetivo = dateObj.getDay() === 6 && CALENDARIO_LETIVO_2025.sabadosLetivos[dateISO];
            const sabadoJust = `(No dia ${dateDisplay}, sábado letivo, foi servida merenda)`;

            if (cardapioPrevisto && selectedCardapio !== cardapioPrevisto) {
                
                const novaJustificativa = `(No dia ${dateDisplay} o cardápio previsto era "${cardapioPrevisto}", mas foi substituido por "${selectedCardapio}")`;
                
                if (!justificativaInput.value || justificativaInput.value === sabadoJust || justificativaInput.value === '-') {
                    alert(`Atenção: O cardápio original de ${dateDisplay} era "${cardapioPrevisto}" e foi alterado para "${selectedCardapio}". Por favor, justifique no campo ao lado.`);
                    justificativaInput.value = novaJustificativa;
                }

            } else if (cardapioPrevisto && selectedCardapio === cardapioPrevisto) {
                if (justificativaInput.value.includes('o cardápio previsto era')) {
                    justificativaInput.value = isSabadoLetivo ? sabadoJust : '-';
                } else if (isSabadoLetivo) {
                    justificativaInput.value = sabadoJust;
                } else {
                    justificativaInput.value = '-';
                }
            }
        }

        function updateRowNumbers() {
            const rows = document.getElementById('table-cardapio-body').querySelectorAll('tr');
            rows.forEach((row, index) => {
                const numCell = row.querySelector('.row-number');
                if (numCell) {
                    numCell.textContent = index + 1;
                }
            });
        }

        function setupTable2RowListeners(newRow) {
            const freqInputs = newRow.querySelectorAll('input[type="number"]');
            freqInputs.forEach(input => {
                input.addEventListener('input', () => validateAttendance(input));
                formatAttendance(input); 
            });

            const selectCardapio = newRow.querySelector('select');
            if (selectCardapio) {
                selectCardapio.addEventListener('change', () => handleCardapioChange(selectCardapio));
            }
        }

        function generateTable2Rows() {
            const tbody = document.getElementById('table-cardapio-body');
            const inicioInput = document.getElementById('periodo_inicio_input').value;
            const fimInput = document.getElementById('periodo_fim_input').value;

            syncSidebarToTable1();
            
            if (!inicioInput || !fimInput) {
                alert("Por favor, defina as datas de início e fim do período.");
                return;
            }

            const startDate = new Date(inicioInput + 'T00:00:00');
            const endDate = new Date(fimInput + 'T00:00:00');

            if (startDate > endDate) {
                alert("A data de início deve ser anterior ou igual à data de fim.");
                return;
            }
            
            tbody.innerHTML = '';
            let currentDate = startDate;

            while (currentDate <= endDate) {
                const dateISO = currentDate.toISOString().substring(0, 10);
                
                if (isLetivo(currentDate)) {
                    const newRow = tbody.insertRow();
                    const dateDisplay = formatDateToDisplay(dateISO);
                    
                    const cardapioPrevisto = getCardapioForDate(currentDate);
                    const isSabadoLetivo = currentDate.getDay() === 6;
                    
                    let justificativaInicial = '-';
                    if (isSabadoLetivo) {
                        justificativaInicial = `(No dia ${dateDisplay}, sábado letivo, foi servida merenda)`;
                    }
                    
                    const optionsHTML = CARDAPIO_OPTIONS.map(opt => 
                        `<option value="${opt}" ${opt === cardapioPrevisto ? 'selected' : ''}>${opt}</option>`
                    ).join('');

                    let rowHTML = `
                        <td class="row-number"></td>
                        <td><input type="date" value="${dateISO}"></td>
                        <td><input type="number" value="X"></td>
                        <td><input type="number" value="X"></td>
                        <td><input type="number" value="X"></td>
                        <td><select>${optionsHTML}</select></td>
                        <td><button class="remove-row-btn" onclick="removeRow(this, 'table-cardapio-body')">&#128465;</button></td>
                        <td><input type="text" value="${justificativaInicial}" style="width: 98%; text-align: left;"></td>
                    `;

                    newRow.innerHTML = rowHTML;
                    setupTable2RowListeners(newRow); 
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            updateRowNumbers();
        }
        
        function addRowTable2() {
            const tbody = document.getElementById('table-cardapio-body');
            const newRow = tbody.insertRow();
            const optionsHTML = CARDAPIO_OPTIONS.map(opt => `<option value="${opt}">${opt}</option>`).join('');

            let rowHTML = `
                <td class="row-number"></td>
                <td><input type="date"></td>
                <td><input type="number" value="X"></td>
                <td><input type="number" value="X"></td>
                <td><input type="number" value="X"></td>
                <td><select>${optionsHTML}</select></td>
                <td><button class="remove-row-btn" onclick="removeRow(this, 'table-cardapio-body')">&#128465;</button></td>
                <td><input type="text" value="-"></td>
            `;

            newRow.innerHTML = rowHTML;
            setupTable2RowListeners(newRow);
            updateRowNumbers();
        }

        // Atualiza o saldo e as unidades de medida na Tabela 3
        function updateTable3Row(element) {
            const row = element.closest('tr');
            if (!row) return;

            const quantInput = row.cells[0].querySelector('input[type="number"]');
            const descSelect = row.cells[1].querySelector('select');
            const consInput = row.cells[2].querySelector('input[type="number"]');
            const saldoAnteriorInput = row.cells[3].querySelector('input[type="number"]');
            const relatorioInput = row.cells[5].querySelector('input[type="text"]');

            const saldoAtualDisplay = row.cells[4];

            // 1. Atualiza Unidades de Medida
            const selectedDescription = descSelect.options[descSelect.selectedIndex].text;
            const unit = UNITS[selectedDescription] || 'un';
            
            row.cells[0].querySelector('.unit').textContent = unit;
            row.cells[2].querySelector('.unit').textContent = unit;
            row.cells[3].querySelector('.unit').textContent = unit;
            
            // 2. Leitura dos valores numéricos reais (ignorando '-')
            const quant = parseFloat(quantInput.value.replace('-', '0')) || 0;
            const cons = parseFloat(consInput.value.replace('-', '0')) || 0;
            const saldoAnterior = parseFloat(saldoAnteriorInput.value.replace('-', '0')) || 0;

            // 3. Formata os valores de entrada para visualização (zero vira '-')
            if (!document.body.classList.contains('printing')) {
                quantInput.value = quant === 0 ? '-' : quant;
                consInput.value = cons === 0 ? '-' : cons;
                saldoAnteriorInput.value = saldoAnterior === 0 ? '-' : saldoAnterior;
                
                // Formata o campo de observação
                if (relatorioInput.value === '' || relatorioInput.value === '0') {
                    relatorioInput.value = '-';
                }
            }
            
            // 4. Cálculo do Saldo (usando os valores numéricos reais)
            const saldoAtual = (quant + saldoAnterior) - cons;

            saldoAtualDisplay.textContent = saldoAtual.toFixed(0) + ' ' + unit;
        }

        function addRowTable3() {
            const tbody = document.getElementById('table-estoque-body');
            const newRow = tbody.insertRow();
            
            const generoOptions = Object.keys(UNITS).map(key => `<option value="${UNITS[key]}">${key}</option>`).join('');

            newRow.innerHTML = `
                <td><div class="quantity-cell"><input type="number" value="-" oninput="updateTable3Row(this)"> <span class="unit">un</span></div></td>
                <td><select onchange="updateTable3Row(this)">${generoOptions}</select></td>
                <td><div class="quantity-cell"><input type="number" value="-" oninput="updateTable3Row(this)"> <span class="unit">un</span></div></td>
                <td><div class="quantity-cell"><input type="number" value="-" oninput="updateTable3Row(this)"> <span class="unit">un</span></div></td>
                <td class="calculated-balance">0 un</td>
                <td><input type="text" value="-" style="width: 95%; text-align: left;" oninput="updateTable3Row(this)"></td>
                <td><button class="remove-row-btn" onclick="removeRow(this, 'table-estoque-body')">&#128465;</button></td>
            `;

            updateTable3Row(newRow.cells[1].querySelector('select'));
        }
        
        function initializeTable3() {
            const tbody = document.getElementById('table-estoque-body');
            tbody.innerHTML = '';

            const defaultItems = Object.keys(UNITS).filter(key => 
                key !== 'OUTRO (a ser especificado)' && 
                !key.includes('Mingau de banana') && 
                !key.includes('Filé de peixe') && 
                !key.includes('Frango desfiado com arroz') && 
                !key.includes('Suco de fruta com pão') &&
                !key.includes('Suco de fruta com biscoito salgado')
            );


            defaultItems.forEach(item => {
                const newRow = tbody.insertRow();
                const unit = UNITS[item];
                
                const generoOptions = Object.keys(UNITS).map(key => 
                    `<option value="${UNITS[key]}" ${key === item ? 'selected' : ''}>${key}</option>`
                ).join('');

                newRow.innerHTML = `
                    <td><div class="quantity-cell"><input type="number" value="-" oninput="updateTable3Row(this)"> <span class="unit">${unit}</span></div></td>
                    <td><select onchange="updateTable3Row(this)">${generoOptions}</select></td>
                    <td><div class="quantity-cell"><input type="number" value="-" oninput="updateTable3Row(this)"> <span class="unit">${unit}</span></div></td>
                    <td><div class="quantity-cell"><input type="number" value="-" oninput="updateTable3Row(this)"> <span class="unit">${unit}</span></div></td>
                    <td class="calculated-balance">0 ${unit}</td>
                    <td><input type="text" value="-" style="width: 95%; text-align: left;" oninput="updateTable3Row(this)"></td>
                    <td><button class="remove-row-btn" onclick="removeRow(this, 'table-estoque-body')">&#128465;</button></td>
                `;
                updateTable3Row(newRow.cells[1].querySelector('select'));
            });
        }


        // --- FUNÇÕES GERAIS ---

        function removeRow(button, tbodyId) {
            const row = button.closest('tr');
            const tbody = document.getElementById(tbodyId);
            if (row && tbody) {
                tbody.removeChild(row);
            }
            if (tbodyId === 'table-cardapio-body') {
                updateRowNumbers();
            }
        }

        // ====================================================================
        //                 FUNÇÕES DE PRÉ E PÓS-IMPRESSÃO
        // ====================================================================

        let originalValuesT2 = [];
        let originalValuesT3 = [];

        // Formata campos para impressão (X na T2, - na T3)
        function applyPrintFormatting() {
            document.body.classList.add('printing');
            
            // Tabela 2: Frequência (Inputs de 'number' de colunas 3, 4, 5)
            const t2Inputs = document.querySelectorAll('#table-cardapio-body td:nth-child(3) input, #table-cardapio-body td:nth-child(4) input, #table-cardapio-body td:nth-child(5) input');
            originalValuesT2 = Array.from(t2Inputs).map(input => {
                const original = input.value;
                if (original === '' || original === '0' || original.toUpperCase() === 'X') {
                    input.value = 'X';
                }
                return { input, original };
            });

            // Tabela 3: Quantidades e Relatório (Inputs de 'number' e 'text')
            const t3Inputs = document.querySelectorAll('#table-estoque-body input');
            originalValuesT3 = Array.from(t3Inputs).map(input => {
                const original = input.value;
                if (input.type === 'number') {
                    // Quantidades T3: 0 ou vazio vira '-'
                    const numericValue = parseFloat(original.replace('-', '0')) || 0;
                    if (numericValue === 0 || original === '') {
                        input.value = '-';
                    }
                } else if (input.type === 'text') {
                    // Relatório T3: vazio vira '-'
                    if (original === '' || original === '0') {
                        input.value = '-';
                    }
                }
                return { input, original };
            });
            
            // Força o recalculo para atualizar a exibição da Tabela 3
            document.querySelectorAll('#table-estoque-body select').forEach(select => updateTable3Row(select));
        }

        // Restaura campos após a impressão
        function restoreOriginalFormatting() {
            document.body.classList.remove('printing');
            
            originalValuesT2.forEach(item => item.input.value = item.original);
            originalValuesT3.forEach(item => item.input.value = item.original);
            
            // Força o recalculo para restaurar a exibição da Tabela 3
            document.querySelectorAll('#table-estoque-body select').forEach(select => updateTable3Row(select));
        }


        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            const table1Inputs = document.querySelectorAll('.sidebar input:not([type="date"]), .sidebar select');
            table1Inputs.forEach(input => {
                if (input.id !== 'document_date_input') {
                    input.addEventListener('input', syncSidebarToTable1);
                    input.addEventListener('change', syncSidebarToTable1);
                }
            });
            
            document.getElementById('document_date_input').addEventListener('change', updateDocumentDate);
            
            // NOVO: Adiciona listener para os botões de rádio do cardápio
            const cardapioRadios = document.querySelectorAll('input[name="tipo_cardapio"]');
            cardapioRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    currentCardapioType = event.target.value;
                    // Se a escolha mudar, regenere a Tabela 2 para aplicar a nova regra de cardápio
                    generateTable2Rows(); 
                });
            });

            syncSidebarToTable1();
            generateTable2Rows();
            initializeTable3();

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('document_date_input').value = today;
            updateDocumentDate(); 
            
            // Adiciona Listeners para eventos de impressão
            if (window.matchMedia) {
                window.matchMedia('print').addListener(function(mql) {
                    if (mql.matches) {
                        applyPrintFormatting();
                    } else {
                        restoreOriginalFormatting();
                    }
                });
            }
            window.onbeforeprint = applyPrintFormatting;
            window.onafterprint = restoreOriginalFormatting;
        });
    </script>-->
</body>
</html>